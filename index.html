<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare OS v11 | Medical Command</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* =========================================
           1. MEDI-UI PRO SYSTEM (v11)
           ========================================= */
        :root {
            --bg-deep: #020617;
            --bg-panel: #0f172a;
            --bg-card: #1e293b;
            --primary: #6366f1;
            --accent: #38bdf8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: 1px solid rgba(255,255,255,0.1);
            --radius: 14px;
            --cursor-x: 50%; --cursor-y: 50%;
        }

        body.hc-mode {
            --bg-deep: #000; --bg-panel: #000; --bg-card: #111;
            --primary: #FFD700; --accent: #00FFFF; --text-main: #FFF;
            --border: 2px solid #FFF;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        body { font-family: 'Manrope', sans-serif; background: var(--bg-deep); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; margin: 0; }

        /* GAZE CURSOR */
        #gaze-cursor {
            position: fixed; top: var(--cursor-y); left: var(--cursor-x);
            width: 20px; height: 20px; border-radius: 50%;
            background: rgba(239, 68, 68, 0.7); border: 2px solid white;
            z-index: 20000; pointer-events: none; transform: translate(-50%, -50%);
            display: none; box-shadow: 0 0 15px var(--danger); transition: 0.08s linear;
        }
        #gaze-cursor.hovering { background: var(--success); transform: translate(-50%, -50%) scale(1.2); }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        /* AUTH SCREEN */
        #auth-layer { position: fixed; inset: 0; z-index: 10000; background: #000; display: flex; align-items: center; justify-content: center; }
        .login-card { width: 420px; padding: 40px; background: var(--bg-panel); border: var(--border); border-radius: 24px; text-align: center; }
        .inp-auth { width: 100%; padding: 14px; margin: 10px 0; background: var(--bg-deep); border: var(--border); color: white; border-radius: 12px; text-align: center; font-size: 1rem; }
        .btn-auth { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 15px; font-size: 1rem; transition:0.3s; }
        .btn-auth:hover { box-shadow: 0 0 20px var(--primary); }

        /* LAYOUT */
        aside { width: 260px; background: var(--bg-panel); border-right: var(--border); padding: 20px; display: flex; flex-direction: column; z-index: 50; }
        .brand { font-size: 1.4rem; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; color: var(--text-main); }
        .nav-item { padding: 12px; color: var(--text-muted); border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.15); color: var(--primary); border-left: 3px solid var(--primary); }
        
        main { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
        
        /* HEADER */
        .top-bar { height: 70px; border-bottom: var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; background: rgba(15,23,42,0.9); backdrop-filter: blur(10px); }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; background: rgba(16, 185, 129, 0.2); color: var(--success); }

        /* VIEWPORT */
        .viewport { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .view-page { display: none; height: 100%; flex-direction: column; gap: 20px; animation: fadeIn 0.3s ease; }
        .view-page.active { display: flex; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

        /* WIDGETS */
        .grid-dash { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; height: 50%; }
        
        .cam-box { background: #000; border-radius: var(--radius); border: var(--border); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        
        /* HUD */
        .hud { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; font-family: 'JetBrains Mono'; font-size: 0.75rem; color: var(--success); border: var(--border); pointer-events: none; z-index: 20; min-width: 160px; }
        .hud-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .cam-controls { position: absolute; bottom: 15px; display: flex; gap: 10px; z-index: 30; }
        .pill { padding: 8px 16px; background: rgba(15,23,42,0.9); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s; }
        .pill:hover { background: var(--primary); border-color: var(--primary); }
        .pill.active { background: var(--danger); border-color: var(--danger); animation: pulse 1.5s infinite; }

        /* TWIN & AAC */
        .twin-box { background: #000; border-radius: var(--radius); border: 1px solid var(--accent); position: relative; overflow: hidden; }
        .aac-panel { background: var(--bg-card); border-radius: var(--radius); border: var(--border); padding: 15px; display: flex; flex-direction: column; }
        .aac-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; flex: 1; overflow-y: auto; }
        .aac-btn { background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; aspect-ratio: 1.2; }
        .aac-btn:hover, .aac-btn.hover-gaze { background: var(--primary); transform: scale(1.05); border-color: white; }

        /* PATIENTS */
        .patient-deck { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 45%; }
        .p-card { background: var(--bg-card); border-radius: var(--radius); border: var(--border); padding: 15px; display: flex; flex-direction: column; position: relative; transition: 0.3s; }
        .p-card.danger { border-color: var(--danger); box-shadow: 0 0 40px rgba(239, 68, 68, 0.4); animation: flash 1s infinite; }
        @keyframes flash { 0%{border-color:var(--danger);} 50%{border-color:transparent;} 100%{border-color:var(--danger);} }

        .ecg-wrap { flex: 1; background: #000; border-radius: 8px; margin-bottom: 10px; position: relative; overflow: hidden; border: var(--border); display: flex; flex-direction: column; }
        .ecg-can { width: 100%; height: 70%; }
        .spo2-can { width: 100%; height: 30%; border-top: 1px solid #333; }

        .ctrl-row { display: flex; gap: 8px; align-items: center; margin-top: auto; }
        .btn-sq { width: 36px; height: 36px; border-radius: 8px; background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-sq.active { background: var(--warning); color: #000; border-color: var(--warning); }

        /* TOAST */
        .toast { position: fixed; top: 20px; right: 20px; background: white; color: #000; padding: 15px 25px; border-radius: 12px; z-index: 12000; transform: translateX(150%); transition: 0.4s; border-left: 5px solid var(--primary); font-weight: bold; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .toast.show { transform: translateX(0); }
        .toast.danger { border-left-color: var(--danger); background: #fee2e2; color: #991b1b; }

        /* QR MODAL */
        #qr-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 11000; display: none; align-items: center; justify-content: center; }
        .modal-card { background: white; padding: 30px; border-radius: 20px; text-align: center; color: black; }

        /* FOOTER */
        .sys-footer { height: 30px; background: #000; border-top: var(--border); display: flex; align-items: center; padding: 0 20px; font-size: 0.7rem; color: #666; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="gaze-cursor"></div>

    <div id="auth-layer">
        <div class="login-card">
            <i class="fas fa-biohazard" style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="color:white; margin-bottom:5px;">VisionCare v11.0</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Architect Stable Build</p>
            <input type="text" id="u" value="admin" class="inp-auth" placeholder="ID">
            <input type="password" id="p" value="admin123" class="inp-auth" placeholder="PIN">
            <button class="btn-auth" onclick="App.login()">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <div id="qr-modal" onclick="this.style.display='none'">
        <div class="modal-card" onclick="event.stopPropagation()">
            <h3>Family Access</h3>
            <div id="qr-target" style="margin:20px auto; display:flex; justify-content:center;"></div>
            <p style="font-size:0.8rem;">Scan to monitor vitals remotely</p>
        </div>
    </div>

    <aside>
        <div class="brand"><i class="fas fa-eye text-primary"></i> VisionCare</div>
        <div class="nav-item active" onclick="Router.go('dash')"><i class="fas fa-desktop"></i> Monitor</div>
        <div class="nav-item" onclick="Router.go('analytics')"><i class="fas fa-chart-line"></i> Analytics</div>
        <div class="nav-item" onclick="Router.go('chat')"><i class="fas fa-comments"></i> Staff Chat</div>
        <div class="nav-item" onclick="Router.go('logs')"><i class="fas fa-list"></i> Logs</div>
        <div class="nav-item" onclick="Router.go('settings')"><i class="fas fa-cog"></i> Settings</div>
        
        <div style="margin-top:auto">
            <div style="font-size:0.7rem; color:var(--text-muted); font-weight:bold; margin-bottom:10px;">ACCESSIBILITY</div>
            <div class="nav-item" onclick="Settings.toggleHC()"><i class="fas fa-adjust"></i> Contrast</div>
            <div class="nav-item text-danger" onclick="location.reload()"><i class="fas fa-power-off"></i> Reboot</div>
        </div>
    </aside>

    <main>
        <div class="top-bar">
            <div>
                <h2 style="font-weight:700; font-size:1.2rem;">ICU Ward 104 - Cardiac</h2>
                <span style="font-size:0.8rem; color:var(--text-muted);" id="clock">00:00:00</span>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                <span class="status-badge">‚óè SYSTEM ONLINE</span>
                <div style="text-align:right">
                    <div style="font-weight:700; font-size:0.9rem;">Dr. Administrator</div>
                    <div style="font-size:0.7rem; color:var(--text-muted);">Chief Medical Officer</div>
                </div>
            </div>
        </div>

        <div class="viewport">
            
            <div id="view-dash" class="view-page active">
                <div class="top-deck">
                    
                    <div class="cam-box">
                        <video id="vid" playsinline muted></video>
                        <canvas id="can"></canvas>
                        
                        <div class="hud">
                            <div class="hud-row"><span>AI ENGINE:</span> <span class="text-success" id="ai-stat">WAITING</span></div>
                            <div class="hud-row"><span>ACTION:</span> <span id="debug-gest" class="text-warning">--</span></div>
                            <div class="hud-row"><span>PAIN:</span> <span id="debug-pain">NO</span></div>
                            <div class="hud-row"><span>FALL:</span> <span id="debug-fall">SAFE</span></div>
                        </div>

                        <div class="cam-ctrls">
                            <button class="pill" onclick="VisionKernel.start()">‚ñ∂ START AI</button>
                            <button class="pill" id="btn-gaze" onclick="GazeKernel.toggle()">üëÅÔ∏è HEAD TRACK</button>
                            <button class="pill" onclick="VoiceKernel.toggle()">üéôÔ∏è VOICE</button>
                        </div>
                    </div>

                    <div class="twin-box">
                        <canvas id="twin_can"></canvas>
                        <div style="position:absolute; top:10px; left:10px; color:var(--accent); font-weight:bold; font-size:0.7rem; background:rgba(0,0,0,0.7); padding:4px;">DIGITAL SKELETON</div>
                    </div>

                    <div class="aac-panel">
                        <div style="font-weight:700; margin-bottom:10px; color:var(--accent); display:flex; justify-content:space-between;">
                            <span>AAC BOARD</span> <i class="fas fa-volume-up"></i>
                        </div>
                        <div class="aac-grid">
                            <div class="aac-btn" onclick="VoiceKernel.speak('I need water')"><i class="fas fa-glass-water text-accent"></i><span style="font-size:0.7rem; margin-top:5px;">WATER</span></div>
                            <div class="aac-btn" onclick="VoiceKernel.speak('I am in pain')"><i class="fas fa-face-grimace text-danger"></i><span style="font-size:0.7rem; margin-top:5px;">PAIN</span></div>
                            <div class="aac-btn" onclick="VoiceKernel.speak('Call Family')"><i class="fas fa-phone text-success"></i><span style="font-size:0.7rem; margin-top:5px;">FAMILY</span></div>
                            <div class="aac-btn" onclick="VoiceKernel.speak('Turn off Lights')"><i class="fas fa-lightbulb text-warning"></i><span style="font-size:0.7rem; margin-top:5px;">LIGHTS</span></div>
                        </div>
                    </div>
                </div>

                <div class="patient-deck">
                    <div class="p-card" id="card-p1">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <div style="display:flex; gap:10px;">
                                <img src="https://via.placeholder.com/50" style="border-radius:10px;">
                                <div><div style="font-weight:700;">Alex Smith</div><div style="font-size:0.7rem; color:gray;">Bed 1</div></div>
                            </div>
                            <span class="status-badge" id="bdg-p1">STABLE</span>
                        </div>
                        <div class="ecg-wrap">
                            <canvas id="ecg-p1" class="ecg-can"></canvas>
                            <canvas id="spo2-p1" class="spo2-can"></canvas>
                        </div>
                        <div id="req-p1" style="text-align:center; font-weight:800; font-size:1.2rem; margin-bottom:10px;">--</div>
                        <div class="ctrl-row">
                            <div class="btn-sq" id="btn-light-p1"><i class="fas fa-lightbulb"></i></div>
                            <div class="btn-sq" id="btn-fan-p1"><i class="fas fa-fan"></i></div>
                            <div class="btn-sq" onclick="PatientMgr.qr(1)"><i class="fas fa-qrcode"></i></div>
                        </div>
                    </div>

                    <div class="p-card" id="card-p2">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <div style="display:flex; gap:10px;">
                                <img src="https://via.placeholder.com/50" style="border-radius:10px;">
                                <div><div style="font-weight:700;">Sarah Doe</div><div style="font-size:0.7rem; color:gray;">Bed 2</div></div>
                            </div>
                            <span class="status-badge" id="bdg-p2">STABLE</span>
                        </div>
                        <div class="ecg-wrap">
                            <canvas id="ecg-p2" class="ecg-can"></canvas>
                            <canvas id="spo2-p2" class="spo2-can"></canvas>
                        </div>
                        <div id="req-p2" style="text-align:center; font-weight:800; font-size:1.2rem; margin-bottom:10px;">--</div>
                        <div class="ctrl-row">
                            <div class="btn-sq" id="btn-light-p2"><i class="fas fa-lightbulb"></i></div>
                            <div class="btn-sq" id="btn-fan-p2"><i class="fas fa-fan"></i></div>
                            <div class="btn-sq" onclick="PatientMgr.qr(2)"><i class="fas fa-qrcode"></i></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-analytics" class="view-page">
                <h2>Real-Time Analytics</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:60%;">
                    <div class="p-card"><canvas id="chart-req"></canvas></div>
                    <div class="p-card"><canvas id="chart-res"></canvas></div>
                </div>
            </div>

            <div id="view-chat" class="view-page">
                <div style="display:flex; height:100%; gap:20px;">
                    <div class="p-card" style="width:250px;">
                        <div style="padding:10px; border-bottom:1px solid #333; font-weight:bold;">Channels</div>
                        <div style="padding:15px; margin-top:10px; background:rgba(255,255,255,0.05); cursor:pointer;">Nurse Station</div>
                    </div>
                    <div class="p-card" style="flex:1;">
                        <div id="chat-box" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px; padding:10px;">
                            <div style="background:var(--bg-panel); padding:10px; border-radius:10px; align-self:flex-start;">System: Chat Connected.</div>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="chat-in" class="inp-auth" style="margin:0; text-align:left;" placeholder="Type...">
                            <button class="btn-auth" style="margin:0; width:auto;" onclick="Chat.send()">SEND</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-logs" class="view-page">
                <div class="p-card" style="height:100%;">
                    <div style="display:flex; justify-content:space-between;">
                        <h3>Audit Logs</h3>
                        <button class="pill" onclick="DataKernel.clear()">Clear</button>
                    </div>
                    <div style="overflow-y:auto; margin-top:15px;">
                        <table style="width:100%; text-align:left; border-collapse:collapse;">
                            <thead style="border-bottom:1px solid #333;"><tr><th style="padding:10px;">Time</th><th>Event</th><th>Type</th></tr></thead>
                            <tbody id="log-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="view-page">
                <div class="p-card">
                    <h3>Configuration</h3>
                    <div style="margin-top:20px; display:flex; flex-direction:column; gap:20px;">
                        <div>
                            <label>Voice Volume</label>
                            <input type="range" style="width:100%; margin-top:5px;" min="0" max="1" step="0.1" onchange="VoiceKernel.vol=this.value">
                        </div>
                        <div>
                            <label>System Theme</label><br>
                            <button class="pill" onclick="Settings.toggleHC()">Toggle High Contrast</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="sys-footer">
            <span>CPU: Optimal</span>
            <span>Memory: 12%</span>
            <span>Network: Secured (Localhost)</span>
            <span>v11.0.0</span>
        </div>
    </main>

    <div id="toast" class="toast">Alert</div>

    <script>
        // --- CONSTANTS ---
        const VIDEO = document.getElementById('vid');
        const CANVAS = document.getElementById('can');
        const CTX = CANVAS.getContext('2d');
        const TWIN_CTX = document.getElementById('twin_can').getContext('2d');
        let lastAction = "";

        // --- 1. CORE SYSTEM ---
        const App = {
            login: () => {
                const u = document.getElementById('u').value;
                const p = document.getElementById('p').value;
                if(u==='admin' && p==='admin123') {
                    document.getElementById('auth-layer').style.display='none';
                    VoiceKernel.speak("Vision Care Enterprise Online");
                    App.init();
                } else alert("Invalid");
            },
            init: () => {
                setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString(), 1000);
                DataKernel.init();
                SimKernel.init();
                Settings.load();
            },
            notify: (msg, crit) => {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.className = crit ? "toast show danger" : "toast show";
                VoiceKernel.speak(msg);
                setTimeout(()=>t.classList.remove('show'), 4000);
                DataKernel.log("SYS", msg, crit?'CRIT':'INFO');
            }
        };

        const Router = {
            go: (id) => {
                document.querySelectorAll('.view-page').forEach(e=>e.classList.remove('active'));
                document.getElementById(`view-${id}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                event.currentTarget.classList.add('active');
                VoiceKernel.speak(id);
            }
        };

        // --- 2. VISION KERNEL ---
        const VisionKernel = {
            start: async () => {
                document.getElementById('ai-stat').innerText = "LOADING...";
                const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
                holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                holistic.onResults(VisionKernel.process);
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720}});
                    VIDEO.srcObject = stream;
                    VIDEO.onloadedmetadata = () => {
                        VIDEO.play();
                        document.getElementById('ai-stat').innerText = "ACTIVE";
                        const cam = new Camera(VIDEO, {onFrame: async()=>{await holistic.send({image:VIDEO});}, width:1280, height:720});
                        cam.start();
                    };
                } catch(e) { alert("Camera Denied"); }
            },
            process: (results) => {
                const w = CANVAS.width = VIDEO.videoWidth;
                const h = CANVAS.height = VIDEO.videoHeight;
                const tC = document.getElementById('twin_can'); tC.width = w; tC.height = h;

                CTX.save(); CTX.clearRect(0,0,w,h); CTX.drawImage(results.image,0,0,w,h);
                drawConnectors(CTX, results.leftHandLandmarks, HAND_CONNECTIONS, {color:'#6366f1', lineWidth:2});
                drawConnectors(CTX, results.rightHandLandmarks, HAND_CONNECTIONS, {color:'#6366f1', lineWidth:2});
                drawConnectors(CTX, results.faceLandmarks, FACEMESH_TESSELATION, {color:'#ffffff20', lineWidth:0.5});
                CTX.restore();

                TWIN_CTX.save(); TWIN_CTX.clearRect(0,0,w,h);
                drawConnectors(TWIN_CTX, results.poseLandmarks, POSE_CONNECTIONS, {color:'#06b6d4', lineWidth:3});
                TWIN_CTX.restore();

                // Logic
                if(results.rightHandLandmarks) VisionKernel.gestures(results.rightHandLandmarks, 1);
                if(results.leftHandLandmarks) VisionKernel.gestures(results.leftHandLandmarks, 2);
                if(results.faceLandmarks) VisionKernel.face(results.faceLandmarks);
                if(results.poseLandmarks) VisionKernel.pose(results.poseLandmarks);
            },
            gestures: (lm, id) => {
                let f=0; [8,12,16,20].forEach(t=>{if(lm[t].y<lm[t-2].y) f++});
                if(Math.abs(lm[4].x-lm[5].x)>0.05) f++;
                const pinch = Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y)<0.05;
                
                let msg="";
                if(pinch) msg="FAN ON";
                else if(f===0) msg="PAIN";
                else if(f===1) msg="MEDS";
                else if(f===2) msg="WATER";
                else if(f===5) msg="LIGHT";

                document.getElementById('debug-gest').innerText = msg || "--";
                if(msg && msg!==lastAction) { lastAction=msg; RoomMgr.trigger(id, msg); setTimeout(()=>lastAction="", 2000); }
            },
            face: (lm) => {
                const pain = Math.hypot(lm[55].x-lm[285].x, lm[55].y-lm[285].y) < 0.04;
                document.getElementById('debug-pain').innerText = pain ? "YES" : "NO";
                if(pain && lastAction!=="PAIN") { lastAction="PAIN"; RoomMgr.trigger(1, "PAIN"); }
                
                if(GazeKernel.active) GazeKernel.move(lm[1].x, lm[1].y);
            },
            pose: (lm) => {
                if(lm[0].y > 0.8 && lastAction!=="FALL") {
                    lastAction="FALL"; document.getElementById('debug-fall').innerText="ALERT";
                    App.notify("FALL DETECTED", true);
                }
            }
        };

        // --- 3. VOICE KERNEL (IMMORTAL) ---
        const VoiceKernel = {
            vol: 1,
            toggle: () => {
                const R = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!R) return alert("Browser No Voice");
                const r = new R(); r.lang='en-US'; r.continuous=true; r.start();
                r.onresult = (e) => {
                    const t = e.results[e.results.length-1][0].transcript.toLowerCase();
                    App.notify(`Voice: "${t}"`, false);
                    if(t.includes('fan')) RoomMgr.trigger(1, "FAN ON");
                    if(t.includes('light')) RoomMgr.trigger(1, "LIGHT");
                    if(t.includes('analytics')) Router.go('analytics');
                    if(t.includes('monitor')) Router.go('dashboard');
                };
                r.onend = () => r.start(); // Auto restart
            },
            speak: (txt) => {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(txt); u.volume=VoiceKernel.vol;
                window.speechSynthesis.speak(u);
            }
        };

        // --- 4. GAZE KERNEL ---
        const GazeKernel = {
            active: false,
            toggle: () => {
                GazeKernel.active = !GazeKernel.active;
                document.getElementById('gaze-cursor').style.display = GazeKernel.active ? 'block' : 'none';
            },
            move: (x, y) => {
                const sx = (1-x)*window.innerWidth; const sy = y*window.innerHeight;
                const c = document.getElementById('gaze-cursor');
                c.style.left = sx+'px'; c.style.top = sy+'px';
                
                const el = document.elementFromPoint(sx, sy);
                if(el && el.classList.contains('aac-btn')) {
                    el.classList.add('hover-gaze'); setTimeout(()=>el.classList.remove('hover-gaze'), 500);
                    c.classList.add('hovering'); setTimeout(()=>c.classList.remove('hovering'), 200);
                }
            }
        };

        // --- 5. ROOM & DATA ---
        const RoomMgr = {
            trigger: (id, msg) => {
                document.getElementById(`req-p${id}`).innerText = msg;
                if(msg==="PAIN") {
                    document.getElementById(`card-p${id}`).classList.add('danger');
                    document.getElementById(`bdg-p${id}`).className="badge badge-crit";
                    document.getElementById(`bdg-p${id}`).innerText="CRITICAL";
                    App.notify(`BED ${id} PAIN ALERT`, true);
                } else {
                    if(msg.includes("FAN")) document.getElementById(`btn-fan-p${id}`).classList.add('active', 'spin');
                    if(msg.includes("LIGHT")) document.getElementById(`btn-light-p${id}`).classList.add('active');
                    App.notify(`Bed ${id}: ${msg}`, false);
                }
            }
        };

        const DataKernel = {
            init: () => { if(!localStorage.getItem('vc_logs')) localStorage.setItem('vc_logs', JSON.stringify([])); DataKernel.render(); },
            log: (mod, evt, crit) => {
                const l = JSON.parse(localStorage.getItem('vc_logs'));
                l.unshift({time:new Date().toLocaleTimeString(), mod, evt, crit});
                localStorage.setItem('vc_logs', JSON.stringify(l));
                DataKernel.render();
            },
            render: () => {
                const l = JSON.parse(localStorage.getItem('vc_logs'));
                document.getElementById('log-body').innerHTML = l.map(x => `
                    <tr style="border-bottom:1px solid #33333330; color:${x.crit==='CRIT'?'#ef4444':'#ccc'}">
                        <td style="padding:10px;">${x.time}</td><td>${x.mod}</td><td>${x.evt}</td>
                    </tr>`).join('');
            },
            clear: () => { localStorage.setItem('vc_logs', JSON.stringify([])); DataKernel.render(); }
        };

        // --- 6. SIMULATION & CHAT ---
        const SimKernel = {
            init: () => {
                SimKernel.startECG(1); SimKernel.startECG(2);
                new Chart(document.getElementById('chart-req'), {type:'doughnut',data:{labels:['Pain','Water','Fan'],datasets:[{data:[5,15,10],backgroundColor:['#ef4444','#38bdf8','#f59e0b']}]},options:{maintainAspectRatio:false}});
                new Chart(document.getElementById('chart-res'), {type:'line',data:{labels:['10am','11am','12pm'],datasets:[{label:'Time (s)',data:[40,20,30],borderColor:'#6366f1'}]},options:{maintainAspectRatio:false}});
            },
            startECG: (id) => {
                const c = document.getElementById(`ecg-p${id}`); const ctx = c.getContext('2d');
                c.width = c.offsetWidth; c.height = c.offsetHeight;
                const c2 = document.getElementById(`spo2-p${id}`); const ctx2 = c2.getContext('2d');
                c2.width = c2.offsetWidth; c2.height = c2.offsetHeight;

                let x=0; ctx.strokeStyle='#10b981'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,c.height/2);
                let x2=0; ctx2.strokeStyle='#38bdf8'; ctx2.lineWidth=2; ctx2.beginPath(); ctx2.moveTo(0,c2.height/2);

                function loop() {
                    x+=2; if(x>c.width) { x=0; ctx.clearRect(0,0,c.width,c.height); ctx.beginPath(); ctx.moveTo(0,c.height/2); }
                    let y=c.height/2; if(Math.random()<0.05) y-=30;
                    ctx.lineTo(x,y); ctx.stroke(); 

                    x2+=1; if(x2>c2.width) { x2=0; ctx2.clearRect(0,0,c2.width,c2.height); ctx2.beginPath(); ctx2.moveTo(0,c2.height/2); }
                    let y2=c2.height/2 + Math.sin(x2*0.1)*10;
                    ctx2.lineTo(x2,y2); ctx2.stroke();

                    requestAnimationFrame(loop);
                }
                loop();
            }
        };

        const Chat = {
            send: () => {
                const i = document.getElementById('chat-in');
                const b = document.getElementById('chat-box');
                if(i.value) {
                    b.innerHTML += `<div style="background:var(--primary); color:white; padding:10px; border-radius:10px; align-self:flex-end;">${i.value}</div>`;
                    i.value="";
                    setTimeout(()=> b.innerHTML += `<div style="background:var(--bg-panel); padding:10px; border-radius:10px; align-self:flex-start;">Received.</div>`, 1000);
                }
            }
        };

        const Settings = {
            load: () => { if(localStorage.getItem('hc_mode')==='true') document.body.classList.add('hc-mode'); },
            toggleHC: () => {
                document.body.classList.toggle('hc-mode');
                localStorage.setItem('hc_mode', document.body.classList.contains('hc-mode'));
            }
        };

        const PatientMgr = {
            snap: (id) => {
                const c = document.createElement('canvas'); c.width=1280; c.height=720;
                c.getContext('2d').drawImage(VIDEO,0,0);
                document.getElementById(`img-p${id}`).src = c.toDataURL('image/png');
                VoiceKernel.speak(`Bed ${id} Registered`);
            },
            qr: (id) => {
                document.getElementById('qr-target').innerHTML = "";
                new QRCode(document.getElementById('qr-target'), {text:`patient:${id}`, width:128, height:128});
                document.getElementById('qr-modal').style.display='flex';
            }
        };
    </script>
</body>
</html>
