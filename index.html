<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare Enterprise | Titan OS v9.0</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        :root {
            --c-bg: #020617; --c-side: #0f172a; --c-panel: #1e293b; --c-card: #334155;
            --c-prim: #6366f1; --c-acc: #06b6d4; --c-success: #10b981; --c-warn: #f59e0b;
            --c-dang: #ef4444; --c-txt: #f8fafc; --rad-lg: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--c-bg); color: var(--c-txt); height: 100vh; overflow: hidden; }
        
        #app-shell { display: flex; height: 100vh; }
        aside { width: 280px; background: var(--c-side); border-right: 1px solid rgba(255,255,255,0.1); padding: 24px; display: flex; flex-direction: column; z-index: 100; }
        .nav-link { padding: 14px; border-radius: 12px; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; font-weight: 500; }
        .nav-link:hover { background: rgba(255,255,255,0.05); }
        .nav-link.active { background: rgba(99, 102, 241, 0.2); color: var(--c-prim); border-left: 4px solid var(--c-prim); }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .viewport { flex: 1; padding: 24px; overflow-y: auto; display: none; }
        .viewport.active { display: block; }

        /* Dashboard Layout */
        .dash-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        .cam-module { position: relative; background: #000; border-radius: var(--rad-lg); height: 500px; border: 2px solid #1e293b; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        video, #can { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }

        /* Patient Cards */
        .p-cards-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px; }
        .p-card { background: var(--c-panel); border-radius: var(--rad-lg); padding: 24px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; }
        .p-card.emergency-crit { border-color: var(--c-dang); animation: flash-danger 0.8s infinite; }
        @keyframes flash-danger { 0%, 100% { background: var(--c-panel); } 50% { background: #450a0a; } }

        /* Vitals & Controls */
        .ecg-monitor { height: 100px; background: #000; border-radius: 12px; margin: 15px 0; border: 1px solid #334155; }
        .hardware-controls { display: flex; gap: 20px; margin-top: 15px; }
        .h-icon { font-size: 1.4rem; color: rgba(255,255,255,0.1); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .h-icon.active { color: var(--c-warn); text-shadow: 0 0 15px var(--c-warn); transform: scale(1.2); }
        .h-icon.fan-spin.active { animation: spin-hardware 2s linear infinite; }
        @keyframes spin-hardware { from { transform: rotate(0deg) scale(1.2); } to { transform: rotate(360deg) scale(1.2); } }

        /* History Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--c-panel); border-radius: 12px; overflow: hidden; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { background: rgba(0,0,0,0.2); font-weight: 600; }

        /* Toasts */
        .toast { position: fixed; top: 24px; right: 24px; background: white; color: #020617; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 9999; transform: translateX(120%); transition: 0.4s; border-left: 6px solid var(--c-prim); }
        .toast.show { transform: translateX(0); }
        .toast.dang { border-left-color: var(--c-dang); }
    </style>
</head>
<body>

    <div id="toast-area"></div>

    <div id="app-shell">
        <aside>
            <div style="font-size:1.6rem; font-weight:800; color:var(--c-prim); margin-bottom:40px;"><i class="fas fa-eye"></i> VisionCare v9</div>
            <nav style="flex:1">
                <div class="nav-link active" onclick="Router.nav('dash')"><i class="fas fa-desktop"></i> Monitoring Hub</div>
                <div class="nav-link" onclick="Router.nav('history')"><i class="fas fa-file-medical"></i> Medical History</div>
                <div class="nav-link" onclick="Router.nav('analytics')"><i class="fas fa-chart-line"></i> Bio-Analytics</div>
                <div class="nav-link" onclick="Router.nav('settings')"><i class="fas fa-sliders-h"></i> System Tuning</div>
            </nav>
            <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; margin-bottom:20px;">
                <div style="font-size:0.7rem; color:#94a3b8; margin-bottom:5px;">AI CORE TEMP</div>
                <div style="height:4px; background:#1e293b; border-radius:2px;"><div style="width:40%; height:100%; background:var(--c-success);"></div></div>
            </div>
            <button class="nav-link" style="border:none; background:none; color:var(--c-dang)" onclick="location.reload()"><i class="fas fa-power-off"></i> System Shutdown</button>
        </aside>

        <div class="main-content">
            <div style="height:80px; padding:0 32px; display:flex; align-items:center; justify-content:between; border-bottom:1px solid rgba(255,255,255,0.1)">
                <div style="flex:1">
                    <h2 id="view-title">ICU Command Centre</h2>
                    <div id="clock" style="color:#94a3b8; font-size:0.9rem">00:00:00</div>
                </div>
                <div style="display:flex; align-items:center; gap:20px">
                    <div style="text-align:right"><div style="font-weight:700">Dr. Yash</div><div style="font-size:0.7rem; color:var(--c-success)">HEAD OF ICU</div></div>
                    <div style="width:44px; height:44px; background:var(--c-prim); border-radius:50%; display:grid; place-items:center; font-weight:800">YS</div>
                </div>
            </div>

            <div class="viewport active" id="v-dash">
                <div class="dash-grid">
                    <div class="cam-module">
                        <video id="vid" playsinline muted></video>
                        <canvas id="can"></canvas>
                        
                        <div style="position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.8); padding:15px; border-radius:12px; font-family:'JetBrains Mono'; border:1px solid rgba(255,255,255,0.1)">
                            <div style="color:var(--c-success)">‚óè AI ENGINE: ACTIVE</div>
                            <div style="margin:5px 0">ACTIVE GESTURE: <span id="st-gesture" style="color:var(--c-warn)">--</span></div>
                            <div style="font-size:0.7rem; color:#64748b">BED BOUNDARY ENABLED</div>
                        </div>

                        <div style="position:absolute; bottom:24px; width:100%; display:flex; justify-content:center; gap:12px">
                            <button class="nav-link active" style="padding:10px 25px" onclick="VisionKernel.start()">INITIALIZE AI</button>
                            <button class="nav-link active" style="padding:10px 25px" onclick="VoiceKernel.listen()"><i class="fas fa-microphone"></i> DOCTOR VOICE</button>
                        </div>
                    </div>

                    <div class="flex flex-col gap-4">
                        <div class="p-card" style="height:260px; background:#000; position:relative">
                            <canvas id="twin_can" style="width:100%; height:100%"></canvas>
                            <div style="position:absolute; top:10px; left:10px; font-size:0.6rem; color:var(--c-acc)">SKELETAL TWINNING ACTIVE</div>
                        </div>
                        <div class="p-card flex-1">
                            <h3>Ward Intelligence</h3>
                            <div style="margin-top:20px; display:flex; flex-direction:column; gap:15px">
                                <div class="flex justify-between"><span>Active SOS Alerts</span><span id="sos-count" class="text-danger">0</span></div>
                                <div class="flex justify-between"><span>Environmental Load</span><span class="text-warning">Nominal</span></div>
                                <div class="flex justify-between"><span>Doctor Proximity</span><span class="text-success">Detected</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-cards-container">
                    <div class="p-card" id="card-p1">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div style="width:52px; height:52px; background:var(--c-prim); border-radius:14px; display:grid; place-items:center; font-weight:800">AS</div>
                                <div><strong id="name-p1">Alex Smith</strong><div style="font-size:0.75rem; color:#94a3b8">Bed 1 ‚Ä¢ Cardiac Unit</div></div>
                            </div>
                            <span id="status-p1" class="badge" style="background:rgba(16,185,129,0.2); color:var(--c-success)">STABLE</span>
                        </div>
                        <div class="ecg-monitor"><canvas id="ecg-1" style="width:100%; height:100%"></canvas></div>
                        <div class="flex justify-between items-center">
                            <div class="hardware-controls">
                                <i class="fas fa-lightbulb h-icon" id="light-p1"></i>
                                <i class="fas fa-fan h-icon fan-spin" id="fan-p1"></i>
                            </div>
                            <div id="req-p1" style="font-weight:800; font-size:1.1rem; color:var(--c-acc)">--</div>
                        </div>
                    </div>

                    <div class="p-card" id="card-p2">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div style="width:52px; height:52px; background:var(--c-acc); border-radius:14px; display:grid; place-items:center; font-weight:800">SD</div>
                                <div><strong id="name-p2">Sarah Doe</strong><div style="font-size:0.75rem; color:#94a3b8">Bed 2 ‚Ä¢ Ortho Dept</div></div>
                            </div>
                            <span id="status-p2" class="badge" style="background:rgba(16,185,129,0.2); color:var(--c-success)">STABLE</span>
                        </div>
                        <div class="ecg-monitor"><canvas id="ecg-2" style="width:100%; height:100%"></canvas></div>
                        <div class="flex justify-between items-center">
                            <div class="hardware-controls">
                                <i class="fas fa-lightbulb h-icon" id="light-p2"></i>
                                <i class="fas fa-fan h-icon fan-spin" id="fan-p2"></i>
                            </div>
                            <div id="req-p2" style="font-weight:800; font-size:1.1rem; color:var(--c-acc)">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="viewport" id="v-history">
                <h2>Patient Medical Records</h2>
                <table>
                    <thead>
                        <tr><th>ID</th><th>Name</th><th>Condition</th><th>Medication</th><th>Admission</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>#1001</td><td>Alex Smith</td><td>Atrial Fibrillation</td><td>Warfarin 5mg</td><td>10 Feb 2026</td></tr>
                        <tr><td>#1002</td><td>Sarah Doe</td><td>Spinal Recovery</td><td>Morphine 2mg</td><td>12 Feb 2026</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="viewport" id="v-analytics">
                <h2>Bio-Analytics Visualization</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-top:24px">
                    <div class="p-card"><canvas id="chart-trends"></canvas></div>
                    <div class="p-card"><canvas id="chart-load"></canvas></div>
                </div>
            </div>

            <div class="viewport" id="v-settings">
                <h2>System Configuration</h2>
                <div class="p-card" style="margin-top:24px; max-width:600px">
                    <div style="margin-bottom:20px">
                        <label>AI Gesture Cooldown (ms)</label>
                        <input type="range" style="width:100%" min="1000" max="5000" value="3000">
                    </div>
                    <div style="margin-bottom:20px">
                        <label>Voice Feedback Rate</label>
                        <input type="range" style="width:100%" min="0.5" max="2" step="0.1" value="1">
                    </div>
                    <button class="nav-link active" onclick="localStorage.clear(); location.reload();">FACTORY RESET SYSTEM</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const VIDEO = document.getElementById('vid');
        const CANVAS = document.getElementById('can');
        const CTX = CANVAS.getContext('2d');
        const TWIN_CTX = document.getElementById('twin_can').getContext('2d');
        const BEEPER = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

        // --- 1. ROUTER ---
        const Router = {
            nav: (view) => {
                document.querySelectorAll('.viewport').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.getElementById('v-' + view).classList.add('active');
                event.currentTarget.classList.add('active');
                VoiceKernel.speak("Displaying " + view);
            }
        };

        // --- 2. VISION KERNEL ---
        const VisionKernel = {
            cooldown: false,
            start: async () => {
                const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
                holistic.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.6 });
                holistic.onResults(VisionKernel.results);

                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                VIDEO.srcObject = stream;
                VIDEO.onloadedmetadata = () => {
                    VIDEO.play();
                    new Camera(VIDEO, { onFrame: async () => { await holistic.send({image: VIDEO}); }, width: 640, height: 480 }).start();
                    Core.notify("AI SYSTEM", "Vision Core and Skeletal Twinning Engaged", false);
                };
            },
            results: (results) => {
                CANVAS.width = VIDEO.videoWidth; CANVAS.height = VIDEO.videoHeight;
                CTX.clearRect(0,0,CANVAS.width,CANVAS.height);
                
                // Drawing Split Boundary
                CTX.strokeStyle = "rgba(255,255,255,0.1)";
                CTX.setLineDash([10, 5]);
                CTX.beginPath(); CTX.moveTo(CANVAS.width/2, 0); CTX.lineTo(CANVAS.width/2, CANVAS.height); CTX.stroke();

                // DUAL PATIENT GESTURE PROCESSING
                [results.leftHandLandmarks, results.rightHandLandmarks].forEach(hand => {
                    if(hand) {
                        const bedId = hand[0].x > 0.5 ? 1 : 2; 
                        const color = bedId === 1 ? '#6366f1' : '#06b6d4';
                        drawConnectors(CTX, hand, HAND_CONNECTIONS, {color: color, lineWidth: 3});
                        VisionKernel.analyze(hand, bedId);
                    }
                });

                // SKELETAL TWINNING
                TWIN_CTX.canvas.width = 300; TWIN_CTX.canvas.height = 300;
                TWIN_CTX.clearRect(0,0,300,300);
                if(results.poseLandmarks) {
                    drawConnectors(TWIN_CTX, results.poseLandmarks, POSE_CONNECTIONS, {color: '#06b6d4', lineWidth: 2});
                    drawLandmarks(TWIN_CTX, results.poseLandmarks, {color: '#ffffff', lineWidth: 1, radius: 2});
                }
            },
            analyze: (lm, id) => {
                if(VisionKernel.cooldown) return;
                let f = 0; [8,12,16,20].forEach(t => { if(lm[t].y < lm[t-2].y) f++; });
                
                let cmd = "";
                if(f === 0) cmd = "EMERGENCY";
                else if(f === 1) cmd = "WATER";
                else if(f === 2) cmd = "FAN";
                else if(f === 5) cmd = "LIGHTS";

                if(cmd) {
                    VisionKernel.cooldown = true;
                    RoomMgr.trigger(id, cmd);
                    document.getElementById('st-gesture').innerText = `B${id}: ${cmd}`;
                    setTimeout(() => { VisionKernel.cooldown = false; }, 3000);
                }
            }
        };

        // --- 3. VOICE KERNEL (Doctor-AI Bridge) ---
        const VoiceKernel = {
            listen: () => {
                const R = window.SpeechRecognition || window.webkitSpeechRecognition;
                const r = new R();
                r.onstart = () => Core.notify("VOICE MODE", "Listening for Doctor Commands", false);
                r.onresult = (e) => {
                    const t = e.results[0][0].transcript.toLowerCase();
                    let bed = (t.includes('two') || t.includes('2')) ? 2 : 1;
                    
                    if(t.includes('fan')) RoomMgr.trigger(bed, "FAN");
                    if(t.includes('light')) RoomMgr.trigger(bed, "LIGHTS");
                    if(t.includes('reset') || t.includes('clear')) RoomMgr.trigger(bed, "CLEAR");
                    if(t.includes('analytics')) Router.nav('analytics');
                };
                r.start();
            },
            speak: (txt) => {
                window.speechSynthesis.cancel();
                const s = new SpeechSynthesisUtterance(txt);
                s.rate = 1.1;
                window.speechSynthesis.speak(s);
            }
        };

        // --- 4. ROOM MANAGER ---
        const RoomMgr = {
            trigger: (id, cmd) => {
                const name = document.getElementById(`name-p${id}`).innerText;
                document.getElementById(`req-p${id}`).innerText = cmd;
                
                if(cmd === "EMERGENCY") {
                    document.getElementById(`card-p${id}`).classList.add('emergency-crit');
                    document.getElementById(`status-p${id}`).innerText = "CRITICAL";
                    document.getElementById(`status-p${id}`).style.background = "red";
                    Core.notify("üö® CRITICAL ALERT", `Patient ${name} is in distress!`, true);
                    BEEPER.play();
                    VoiceKernel.speak(`Emergency detected for ${name}. Assist immediately.`);
                } else if (cmd === "FAN") {
                    document.getElementById(`fan-p${id}`).classList.toggle('active');
                    VoiceKernel.speak(`Activating fan for ${name}`);
                } else if (cmd === "LIGHTS") {
                    document.getElementById(`light-p${id}`).classList.toggle('active');
                    VoiceKernel.speak(`Toggling lights for ${name}`);
                } else if (cmd === "CLEAR") {
                    document.getElementById(`card-p${id}`).classList.remove('emergency-crit');
                    document.getElementById(`status-p${id}`).innerText = "STABLE";
                    document.getElementById(`status-p${id}`).style.background = "rgba(16,185,129,0.2)";
                    document.getElementById(`req-p${id}`).innerText = "--";
                } else {
                    VoiceKernel.speak(`${name} has requested ${cmd}`);
                }
            }
        };

        // --- 5. BIOMETRICS & ECG ---
        const SimKernel = {
            startECG: (id) => {
                const c = document.getElementById(`ecg-${id}`);
                const cx = c.getContext('2d');
                let x = 0;
                function loop() {
                    if(x > c.width) { x = 0; cx.clearRect(0,0,c.width,c.height); }
                    cx.strokeStyle = id === 1 ? "#10b981" : "#06b6d4";
                    cx.lineWidth = 2; cx.beginPath(); cx.moveTo(x, c.height/2);
                    x += 2;
                    let y = c.height/2 + (Math.random() > 0.96 ? -30 : 0);
                    cx.lineTo(x, y); cx.stroke();
                    requestAnimationFrame(loop);
                }
                loop();
            }
        };

        const Core = {
            notify: (title, msg, isCrit) => {
                const t = document.createElement('div');
                t.className = `toast ${isCrit ? 'dang' : ''}`;
                t.innerHTML = `<strong>${title}</strong><br>${msg}`;
                document.getElementById('toast-area').appendChild(t);
                t.classList.add('show');
                setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 5000);
            }
        };

        // Bootstrapping
        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        SimKernel.startECG(1);
        SimKernel.startECG(2);
    </script>
</body>
</html>
