<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare Titan | Enterprise Medical OS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* --- TITAN DESIGN SYSTEM v2.0 --- */
        :root {
            --bg-core: #0f172a; --bg-panel: #1e293b; --bg-surface: #334155;
            --primary: #6366f1; --primary-dim: rgba(99,102,241,0.2);
            --accent: #0ea5e9; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: 1px solid rgba(255,255,255,0.08);
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            --font-ui: 'Inter', sans-serif; --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; outline: none; }
        body { background: var(--bg-core); color: var(--text-main); font-family: var(--font-ui); margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* --- LAYOUT ARCHITECTURE --- */
        #app-root { display: flex; width: 100%; height: 100%; }
        
        /* SIDEBAR NAV */
        aside { width: 280px; background: var(--bg-panel); border-right: var(--border); display: flex; flex-direction: column; z-index: 50; }
        .brand-header { padding: 25px; border-bottom: var(--border); display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 8px; }
        .nav-menu { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 5px; }
        .nav-item { padding: 12px 16px; border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-weight: 500; }
        .nav-item:hover, .nav-item.active { background: var(--primary-dim); color: var(--primary); }
        .nav-item i { width: 20px; text-align: center; }

        /* MAIN WORKSPACE */
        main { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        header { height: 70px; border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: rgba(15,23,42,0.8); backdrop-filter: blur(10px); z-index: 40; }
        
        .workspace { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .workspace.active { display: block; animation: fade-in 0.3s ease; }

        /* DASHBOARD GRID SYSTEM */
        .dash-grid { display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: 500px auto; gap: 25px; }
        .panel { background: var(--bg-panel); border: var(--border); border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--shadow); position: relative; }
        .panel-head { padding: 15px 20px; border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.1); }
        .panel-title { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* VISION ENGINE UI */
        .viewport { flex: 1; background: #000; position: relative; }
        video#vid { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.6; }
        canvas#can { position: absolute; inset: 0; width: 100%; height: 100%; transform: scaleX(-1); }
        .overlay-hud { position: absolute; bottom: 20px; left: 20px; font-family: var(--font-code); font-size: 0.75rem; color: var(--accent); background: rgba(0,0,0,0.7); padding: 10px; border-radius: 6px; border: 1px solid var(--accent); }

        /* PATIENT CARDS & LISTS */
        .patient-list { display: flex; flex-direction: column; }
        .patient-row { padding: 15px 20px; border-bottom: var(--border); display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; }
        .patient-row:hover { background: var(--bg-surface); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; object-fit: cover; border: 2px solid var(--success); }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .status-badge.crit { background: rgba(239,68,68,0.2); color: var(--danger); }
        .status-badge.ok { background: rgba(16,185,129,0.2); color: var(--success); }

        /* ANALYTICS MODULES */
        .chart-container { padding: 20px; height: 250px; position: relative; }
        .metric-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 20px; }
        .metric-box { background: var(--bg-surface); padding: 15px; border-radius: 12px; }
        .metric-val { font-size: 1.8rem; font-weight: 700; color: var(--text-main); }
        .metric-label { font-size: 0.8rem; color: var(--text-muted); }

        /* VOICE COMMAND BAR */
        .voice-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--bg-panel); border: 1px solid var(--primary); padding: 12px 30px; border-radius: 50px; display: flex; align-items: center; gap: 15px; box-shadow: 0 0 40px rgba(99,102,241,0.3); z-index: 100; transition: 0.3s; }
        .voice-bar.listening { border-color: var(--success); box-shadow: 0 0 40px rgba(16,185,129,0.3); }
        .wave-anim { display: flex; gap: 3px; height: 15px; align-items: center; }
        .bar { width: 3px; background: var(--text-main); height: 100%; animation: wave 1s infinite; }

        @keyframes wave { 0%, 100% { height: 5px; } 50% { height: 15px; } }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="app-root">
        <aside>
            <div class="brand-header">
                <div class="brand-logo"></div>
                <div>
                    <div style="font-weight:700;">VisionCare Titan</div>
                    <div style="font-size:0.7rem; color:var(--text-muted);">Enterprise Ed. v4.2</div>
                </div>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="App.router.navigate('dash')"><i class="fas fa-grid-2"></i> Dashboard</div>
                <div class="nav-item" onclick="App.router.navigate('patients')"><i class="fas fa-users-medical"></i> Patient Registry</div>
                <div class="nav-item" onclick="App.router.navigate('analytics')"><i class="fas fa-waveform-path"></i> Bio-Analytics</div>
                <div class="nav-item" onclick="App.router.navigate('neural')"><i class="fas fa-network-wired"></i> Neural Config</div>
                <div class="nav-item" onclick="App.router.navigate('logs')"><i class="fas fa-terminal"></i> System Logs</div>
            </div>
            <div style="margin-top:auto; padding:20px;">
                <div class="panel" style="padding:15px; background:var(--bg-surface);">
                    <div style="font-size:0.75rem; color:var(--text-muted);">SERVER STATUS</div>
                    <div style="display:flex; align-items:center; gap:8px; margin-top:5px; color:var(--success); font-weight:bold;">
                        <div style="width:8px; height:8px; background:var(--success); border-radius:50%;"></div>
                        ONLINE (12ms)
                    </div>
                </div>
            </div>
        </aside>

        <main>
            <header>
                <div style="font-weight:600; font-size:1.1rem;" id="page-title">Command Center</div>
                <div style="display:flex; gap:20px; align-items:center;">
                    <button style="background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600;" onclick="App.hardware.emergency()">EMERGENCY STOP</button>
                    <div class="avatar" style="background:url('https://i.pravatar.cc/150?u=admin') center/cover;"></div>
                </div>
            </header>

            <div id="view-dash" class="workspace active">
                <div class="dash-grid">
                    <div class="panel">
                        <div class="panel-head">
                            <span class="panel-title">Live Vision Feed (Room 402)</span>
                            <i class="fas fa-video" style="color:var(--success)"></i>
                        </div>
                        <div class="viewport">
                            <video id="vid" playsinline muted></video>
                            <canvas id="can"></canvas>
                            <div class="overlay-hud">
                                <div>AI_MODEL: HOLISTIC_V4</div>
                                <div>FPS: <span id="fps-counter">60</span></div>
                                <div>OBJECTS: <span id="obj-counter">2</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-head"><span class="panel-title">Vital Summary</span></div>
                        <div class="metric-grid">
                            <div class="metric-box">
                                <div class="metric-label">Heart Rate (Avg)</div>
                                <div class="metric-val" style="color:var(--danger)">72 <small style="font-size:1rem;">bpm</small></div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">SpO2 Level</div>
                                <div class="metric-val" style="color:var(--accent)">98 <small style="font-size:1rem;">%</small></div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Room Temp</div>
                                <div class="metric-val">22.5 <small style="font-size:1rem;">Â°C</small></div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-label">Active Alerts</div>
                                <div class="metric-val" style="color:var(--warning)">0</div>
                            </div>
                        </div>
                        <div class="chart-container" style="height:150px;">
                            <canvas id="mini-ecg"></canvas>
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-head"><span class="panel-title">Active Patients</span></div>
                        <div class="patient-list" id="patient-list-container">
                            </div>
                    </div>

                    <div class="panel">
                        <div class="panel-head"><span class="panel-title">3D Biometric Map</span></div>
                        <div id="three-container" style="flex:1; background:#000;"></div>
                    </div>
                </div>
            </div>

            <div id="view-patients" class="workspace">
                <h2>Patient Registry Database</h2>
                <div class="panel" style="margin-top:20px;">
                    <table style="width:100%; text-align:left; border-collapse:collapse; color:var(--text-muted);">
                        <thead style="background:rgba(0,0,0,0.2); border-bottom:var(--border);">
                            <tr><th style="padding:15px;">ID</th><th>Name</th><th>Condition</th><th>Status</th><th>Admitted</th></tr>
                        </thead>
                        <tbody id="registry-table"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-analytics" class="workspace">
                <h2>Historical Biometrics</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
                    <div class="panel" style="padding:20px;"><canvas id="chart-hr"></canvas></div>
                    <div class="panel" style="padding:20px;"><canvas id="chart-bp"></canvas></div>
                </div>
            </div>

        </main>
    </div>

    <div class="voice-bar" id="voice-hud">
        <i class="fas fa-microphone"></i>
        <div class="wave-anim">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        </div>
        <div id="voice-text" style="font-weight:500;">System Listening...</div>
    </div>

    <script>
        /**
         * VISIONCARE TITAN CORE ARCHITECTURE
         * * Modules:
         * 1. Store: Central State Management (Redux-pattern)
         * 2. Router: SPA Navigation Controller
         * 3. Vision: Mediapipe Holistic Integration
         * 4. Voice: Speech Recognition & NLP Processor
         * 5. BioEngine: Biological Data Simulation
         * 6. RenderEngine: Three.js & Chart.js Visualization
         */

        // --- 1. CENTRAL STORE (State Management) ---
        const Store = {
            state: {
                user: { name: 'Dr. Admin', role: 'Chief Officer' },
                patients: [
                    { id: 'P-101', name: 'Alex Smith', age: 34, condition: 'Post-Op Recovery', status: 'stable', hr: 72, spo2: 98, bed: 1, avatar: 'u=1' },
                    { id: 'P-102', name: 'Sarah Doe', age: 29, condition: 'Cardiac Monitor', status: 'critical', hr: 110, spo2: 94, bed: 2, avatar: 'u=2' },
                    { id: 'P-103', name: 'Michael Chen', age: 45, condition: 'Observation', status: 'stable', hr: 68, spo2: 99, bed: 3, avatar: 'u=3' }
                ],
                hardware: { fan: false, lights: true, ac: 22 },
                logs: []
            },
            get: (key) => Store.state[key],
            dispatch: (action, payload) => {
                console.log(`[STORE] Dispatch: ${action}`, payload);
                if(action === 'UPDATE_VITALS') {
                    const p = Store.state.patients.find(x => x.id === payload.id);
                    if(p) Object.assign(p, payload.data);
                }
                if(action === 'TOGGLE_HARDWARE') {
                    Store.state.hardware[payload.device] = payload.state;
                    App.voice.speak(`${payload.device} turned ${payload.state ? 'on' : 'off'}`);
                }
                App.ui.render(); // Re-render UI on state change
            }
        };

        // --- 2. APPLICATION CONTROLLER ---
        const App = {
            init: () => {
                App.router.init();
                App.vision.init();
                App.voice.init();
                App.charts.init();
                App.renderer.init3D();
                App.bio.startLoop();
                App.ui.render();
            },
            
            // UI Renderer
            ui: {
                render: () => {
                    // Render Patient List (Dashboard)
                    const list = document.getElementById('patient-list-container');
                    list.innerHTML = Store.get('patients').map(p => `
                        <div class="patient-row" onclick="App.router.navigate('patients')">
                            <img src="https://i.pravatar.cc/150?${p.avatar}" class="avatar">
                            <div style="flex:1;">
                                <div style="font-weight:600;">${p.name}</div>
                                <div style="font-size:0.8rem; color:var(--text-muted);">${p.condition}</div>
                            </div>
                            <div class="status-badge ${p.status === 'stable' ? 'ok' : 'crit'}">${p.status}</div>
                            <div style="font-family:var(--font-code); font-size:0.9rem;">${p.hr} <small>BPM</small></div>
                        </div>
                    `).join('');

                    // Render Registry Table (Patients View)
                    const table = document.getElementById('registry-table');
                    table.innerHTML = Store.get('patients').map(p => `
                        <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                            <td style="padding:15px;">${p.id}</td>
                            <td>${p.name}</td>
                            <td>${p.condition}</td>
                            <td><span class="status-badge ${p.status === 'stable' ? 'ok' : 'crit'}">${p.status}</span></td>
                            <td>Feb 14, 2026</td>
                        </tr>
                    `).join('');
                }
            },

            // Navigation Router
            router: {
                init: () => {
                    document.querySelectorAll('.nav-item').forEach(el => {
                        el.addEventListener('click', function() {
                            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
                            this.classList.add('active');
                        });
                    });
                },
                navigate: (viewId) => {
                    document.querySelectorAll('.workspace').forEach(el => el.classList.remove('active'));
                    document.getElementById(`view-${viewId}`).classList.add('active');
                    document.getElementById('page-title').innerText = viewId.charAt(0).toUpperCase() + viewId.slice(1);
                }
            },

            // Hardware Interface
            hardware: {
                emergency: () => {
                    alert("EMERGENCY PROTOCOL INITIATED: ALL SYSTEMS HALTED");
                    App.voice.speak("Emergency Stop Activated. Calling medical response team.");
                }
            }
        };

        // --- 3. VISION ENGINE (Mediapipe) ---
        App.vision = {
            init: async () => {
                const vid = document.getElementById('vid');
                const can = document.getElementById('can');
                const ctx = can.getContext('2d');
                
                const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
                holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                
                holistic.onResults((res) => {
                    can.width = vid.videoWidth; can.height = vid.videoHeight;
                    ctx.clearRect(0, 0, can.width, can.height);
                    ctx.drawImage(res.image, 0, 0, can.width, can.height);
                    
                    if(res.poseLandmarks) {
                        drawConnectors(ctx, res.poseLandmarks, POSE_CONNECTIONS, {color: '#6366f1', lineWidth: 2});
                        drawLandmarks(ctx, res.poseLandmarks, {color: '#0ea5e9', lineWidth: 1, radius: 2});
                    }
                });

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({video: {width: 1280, height: 720}});
                    vid.srcObject = stream;
                    vid.play();
                    const camera = new Camera(vid, {onFrame: async () => { await holistic.send({image: vid}); }, width: 1280, height: 720});
                    camera.start();
                } catch(e) { console.error("Camera Init Failed", e); }
            }
        };

        // --- 4. VOICE OS (Speech Recognition) ---
        App.voice = {
            init: () => {
                const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!Speech) return;
                const rec = new Speech();
                rec.continuous = true;
                rec.interimResults = false;
                
                rec.onstart = () => document.getElementById('voice-hud').classList.add('listening');
                rec.onend = () => rec.start(); // Auto-restart
                
                rec.onresult = (e) => {
                    const transcript = e.results[e.results.length-1][0].transcript.toLowerCase();
                    document.getElementById('voice-text').innerText = `CMD: "${transcript}"`;
                    App.voice.process(transcript);
                };
                rec.start();
            },
            process: (cmd) => {
                // Regex Command Parsing
                if(/fan.*on/.test(cmd)) Store.dispatch('TOGGLE_HARDWARE', {device: 'fan', state: true});
                if(/fan.*off/.test(cmd)) Store.dispatch('TOGGLE_HARDWARE', {device: 'fan', state: false});
                if(/dashboard/.test(cmd)) App.router.navigate('dash');
                if(/patients/.test(cmd)) App.router.navigate('patients');
                if(/emergency/.test(cmd)) App.hardware.emergency();
            },
            speak: (text) => {
                const utt = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(utt);
            }
        };

        // --- 5. BIO ENGINE (Simulation) ---
        App.bio = {
            startLoop: () => {
                setInterval(() => {
                    // Update patient data randomly to simulate life
                    Store.get('patients').forEach(p => {
                        const newHr = p.hr + (Math.random() > 0.5 ? 1 : -1);
                        Store.dispatch('UPDATE_VITALS', { id: p.id, data: { hr: newHr } });
                    });
                }, 2000);
            }
        };

        // --- 6. RENDER ENGINE (Charts & 3D) ---
        App.charts = {
            init: () => {
                const ctx = document.getElementById('mini-ecg').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(20).fill(''),
                        datasets: [{ data: Array(20).fill(0).map(()=>Math.random()*100), borderColor: '#10b981', tension: 0.4, borderWidth: 2, pointRadius: 0 }]
                    },
                    options: { plugins: {legend: {display: false}}, scales: {x: {display:false}, y: {display:false}}, animation: false }
                });
            }
        };

        App.renderer = {
            init3D: () => {
                // Basic Three.js Setup for Body Map
                const container = document.getElementById('three-container');
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, container.clientWidth / 200, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({alpha: true});
                renderer.setSize(container.clientWidth, 200);
                container.appendChild(renderer.domElement);

                const geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
                const material = new THREE.MeshBasicMaterial({ color: 0x6366f1, wireframe: true });
                const torus = new THREE.Mesh(geometry, material);
                scene.add(torus);
                camera.position.z = 30;

                function animate() {
                    requestAnimationFrame(animate);
                    torus.rotation.x += 0.01;
                    torus.rotation.y += 0.01;
                    renderer.render(scene, camera);
                }
                animate();
            }
        };

        // BOOT SYSTEM
        window.onload = App.init;

    </script>
</body>
</html>
