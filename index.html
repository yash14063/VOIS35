<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare - ICU Command Center</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* =========================================
           THEME ENGINE
           ========================================= */
        :root {
            --bg-app: #0b1121; --bg-panel: #151e32; --bg-card: #1e293b;
            --primary: #3b82f6; --primary-glow: rgba(59, 130, 246, 0.5);
            --accent: #06b6d4;
            --success: #10b981; --success-glow: rgba(16, 185, 129, 0.3);
            --danger: #ef4444; --danger-glow: rgba(239, 68, 68, 0.4);
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --ecg-line: #10b981;
            
            --sidebar-w: 280px;
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-app); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* =========================================
           LOGIN SCREEN
           ========================================= */
        #auth-layer {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .login-card {
            width: 420px; padding: 40px; background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; text-align: center;
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.2);
        }
        .form-input {
            width: 100%; padding: 14px; margin: 10px 0; background: #0f172a; 
            border: 1px solid #334155; color: white; border-radius: 12px; font-size: 1rem; text-align: center; transition: 0.3s;
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }
        .btn-primary {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--primary-glow); }

        /* =========================================
           DASHBOARD LAYOUT
           ========================================= */
        aside {
            width: var(--sidebar-w); background: var(--bg-panel); border-right: 1px solid #334155;
            display: flex; flex-direction: column; padding: 25px; z-index: 50;
        }
        .brand { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 40px; display: flex; align-items: center; gap: 12px; }
        .brand i { color: var(--primary); }
        
        .nav-item {
            padding: 14px 16px; margin-bottom: 8px; border-radius: 12px; color: var(--text-muted); 
            cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .nav-item.active { border-left: 4px solid var(--primary); }

        main { flex: 1; display: flex; flex-direction: column; height: 100%; padding: 20px; gap: 20px; overflow-y: auto; }

        /* =========================================
           CAMERA SECTION
           ========================================= */
        .top-row { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; height: 45%; }
        
        .cam-widget {
            background: black; border-radius: var(--radius); position: relative; border: 2px solid #334155; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        
        .cam-overlay { position: absolute; bottom: 20px; z-index: 20; display: flex; gap: 15px; }
        .btn-cam { padding: 10px 20px; background: rgba(0,0,0,0.7); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius: 30px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: 0.3s; }
        .btn-cam:hover { background: var(--primary); border-color: var(--primary); }

        /* Legend */
        .info-panel { background: var(--bg-card); border-radius: var(--radius); padding: 20px; border: 1px solid #334155; overflow-y: auto; }
        .gesture-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; margin-bottom: 8px; border: 1px solid transparent; transition: 0.3s; }
        .gesture-item.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); transform: scale(1.02); }
        .g-icon { font-size: 1.5rem; width: 30px; text-align: center; }

        /* =========================================
           PATIENT & ECG SECTION
           ========================================= */
        .patient-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 50%; }
        
        .patient-card {
            background: var(--bg-card); border-radius: var(--radius); padding: 20px; border: 1px solid #334155;
            display: flex; flex-direction: column; position: relative; transition: 0.3s;
        }
        .patient-card.emergency { border-color: var(--danger); box-shadow: 0 0 30px var(--danger-glow); }

        .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .p-profile { display: flex; gap: 15px; align-items: center; }
        .p-photo { width: 70px; height: 70px; border-radius: 18px; background: #334155; object-fit: cover; border: 2px solid #475569; }
        
        .ecg-container {
            flex: 1; background: #000; border-radius: 12px; position: relative; overflow: hidden; border: 1px solid #334155;
            display: flex; flex-direction: column;
        }
        .ecg-canvas { width: 100%; height: 100%; }
        .ecg-overlay { position: absolute; top: 10px; right: 10px; text-align: right; }
        .bpm-display { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--success); }
        .bpm-label { font-size: 0.7rem; color: #64748b; letter-spacing: 1px; }

        .risk-bar { margin-top: 15px; }
        .risk-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .progress-track { height: 8px; background: #334155; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 20%; background: var(--success); transition: 0.5s; }

        /* STATUS BADGES */
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-safe { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); animation: pulse 1s infinite; }

        /* TOAST */
        .toast { position: fixed; top: 20px; right: 20px; background: white; color: #0f172a; padding: 15px 25px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; gap: 15px; transform: translateX(200%); transition: 0.4s; border-left: 5px solid var(--primary); width: 350px; }
        .toast.show { transform: translateX(0); }
        .toast.danger { border-left-color: var(--danger); background: #fef2f2; }

    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="login-card">
            <i class="fas fa-heart-pulse" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="margin-bottom: 10px;">VisionCare Enterprise</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;">ICU Command & ECG Monitor</p>
            
            <input type="text" id="login-user" class="form-input" placeholder="Doctor ID (admin)">
            <input type="password" id="login-pass" class="form-input" placeholder="Access Code (admin123)">
            <button class="btn-primary" onclick="Auth.login()">Launch Dashboard</button>
        </div>
    </div>

    <aside>
        <div class="brand"><i class="fas fa-hospital-user"></i> VisionCare</div>
        <div class="nav-item active"><i class="fas fa-procedures"></i> ICU Ward Monitor</div>
        <div class="nav-item"><i class="fas fa-chart-line"></i> Vitals Analytics</div>
        <div class="nav-item"><i class="fas fa-user-injured"></i> Patient Records</div>
        <div class="nav-item" style="margin-top:auto; color:var(--danger);" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> Logout System</div>
    </aside>

    <main>
        <div class="top-row">
            <div class="cam-widget">
                <video id="video_feed" playsinline muted></video>
                <canvas id="ai_overlay"></canvas>
                <div class="cam-overlay">
                    <button class="btn-cam" onclick="PatientSys.register(1)">üì∏ Reg Bed 1</button>
                    <button class="btn-cam" style="background:var(--primary); border:none;" onclick="VisionSys.start()">‚ñ∂ START AI ENGINE</button>
                    <button class="btn-cam" onclick="PatientSys.register(2)">üì∏ Reg Bed 2</button>
                </div>
            </div>

            <div class="info-panel">
                <h4 style="color:var(--text-muted); margin-bottom:15px; font-size:0.85rem; text-transform:uppercase;">Gesture Library</h4>
                <div class="gesture-item" id="leg-pain">
                    <div class="g-icon">‚úä</div>
                    <div><strong>Fist Clench</strong><br><small style="color:var(--text-muted)">Chest Pain / SOS</small></div>
                </div>
                <div class="gesture-item" id="leg-help">
                    <div class="g-icon">‚úã</div>
                    <div><strong>Open Palm</strong><br><small style="color:var(--text-muted)">Nurse Help</small></div>
                </div>
                <div class="gesture-item" id="leg-water">
                    <div class="g-icon">‚úåÔ∏è</div>
                    <div><strong>V-Sign</strong><br><small style="color:var(--text-muted)">Water</small></div>
                </div>
                <div class="gesture-item" id="leg-meds">
                    <div class="g-icon">‚òùÔ∏è</div>
                    <div><strong>One Finger</strong><br><small style="color:var(--text-muted)">Medicine</small></div>
                </div>
            </div>
        </div>

        <div class="patient-grid">
            
            <div class="patient-card" id="card-p1">
                <div class="card-header">
                    <div class="p-profile">
                        <img id="img-p1" src="https://via.placeholder.com/80/334155/FFFFFF?text=Bed1" class="p-photo">
                        <div>
                            <h3>Alex Smith</h3>
                            <small style="color:var(--text-muted)">Bed 1 ‚Ä¢ Cardiac Unit</small>
                        </div>
                    </div>
                    <div class="status-badge badge-safe" id="badge-p1">Stable</div>
                </div>

                <div class="ecg-container">
                    <canvas id="ecg-p1" class="ecg-canvas"></canvas>
                    <div class="ecg-overlay">
                        <div class="bpm-display" id="bpm-p1">72</div>
                        <div class="bpm-label">BPM</div>
                    </div>
                </div>

                <div class="risk-bar">
                    <div class="risk-label"><span>Heart Attack Risk</span><span id="risk-txt-p1">2%</span></div>
                    <div class="progress-track"><div class="progress-fill" id="risk-bar-p1" style="width:2%"></div></div>
                </div>
                
                <div style="margin-top:10px; font-weight:600; font-size:1.1rem; color:var(--text-main); text-align:center;" id="req-p1">Monitoring...</div>
            </div>

            <div class="patient-card" id="card-p2">
                <div class="card-header">
                    <div class="p-profile">
                        <img id="img-p2" src="https://via.placeholder.com/80/334155/FFFFFF?text=Bed2" class="p-photo">
                        <div>
                            <h3>Sarah Doe</h3>
                            <small style="color:var(--text-muted)">Bed 2 ‚Ä¢ Observation</small>
                        </div>
                    </div>
                    <div class="status-badge badge-safe" id="badge-p2">Stable</div>
                </div>

                <div class="ecg-container">
                    <canvas id="ecg-p2" class="ecg-canvas"></canvas>
                    <div class="ecg-overlay">
                        <div class="bpm-display" id="bpm-p2">68</div>
                        <div class="bpm-label">BPM</div>
                    </div>
                </div>

                <div class="risk-bar">
                    <div class="risk-label"><span>Heart Attack Risk</span><span id="risk-txt-p2">5%</span></div>
                    <div class="progress-track"><div class="progress-fill" id="risk-bar-p2" style="width:5%"></div></div>
                </div>

                <div style="margin-top:10px; font-weight:600; font-size:1.1rem; color:var(--text-main); text-align:center;" id="req-p2">Monitoring...</div>
            </div>

        </div>
    </main>

    <div id="toast" class="toast">
        <div style="font-size:2rem;">üîî</div>
        <div>
            <div style="font-weight:700; margin-bottom:2px;" id="toast-title">Alert</div>
            <div style="font-size:0.9rem; color:#64748b;" id="toast-msg">Message</div>
        </div>
    </div>

    <script>
        /**
         * --------------------------------------------------------
         * 1. AUTHENTICATION MODULE
         * --------------------------------------------------------
         */
        const Auth = {
            login: () => {
                const u = document.getElementById('login-user').value;
                const p = document.getElementById('login-pass').value;
                if(u === 'admin' && p === 'admin123') {
                    document.getElementById('auth-layer').style.display = 'none';
                    if ("Notification" in window) Notification.requestPermission();
                    ECG.start(1);
                    ECG.start(2);
                } else {
                    alert("Invalid Credentials");
                }
            }
        };

        /**
         * --------------------------------------------------------
         * 2. ECG SIMULATOR ENGINE (The "Wow" Factor)
         * --------------------------------------------------------
         */
        const ECG = {
            patients: { 1: { bpm: 72, stress: 0, ctx: null, x: 0 }, 2: { bpm: 68, stress: 0, ctx: null, x: 0 } },
            
            start: (id) => {
                const canvas = document.getElementById(`ecg-p${id}`);
                const ctx = canvas.getContext('2d');
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                ECG.patients[id].ctx = ctx;
                ECG.patients[id].h = canvas.height;
                ECG.patients[id].w = canvas.width;
                
                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);

                ECG.animate(id);
            },

            animate: (id) => {
                const p = ECG.patients[id];
                const ctx = p.ctx;
                
                // Simulate Heartbeat logic
                const speed = 2 + (p.stress * 0.1); 
                p.x += speed;
                
                // Reset scanline
                if (p.x > p.w) {
                    p.x = 0;
                    ctx.clearRect(0, 0, p.w, p.h);
                    ctx.beginPath();
                    ctx.moveTo(0, p.h / 2);
                }

                // Waveform Generation (Normal vs Heart Attack)
                let y = p.h / 2;
                
                // Random jitter
                y += (Math.random() - 0.5) * (5 + p.stress);

                // QRS Complex (The "Beep")
                if (Math.random() < 0.02 + (p.stress * 0.001)) {
                    y -= (40 + p.stress); // Spike
                }

                ctx.lineTo(p.x, y);
                ctx.stroke();

                // Dynamic Color Change on Stress
                ctx.strokeStyle = p.stress > 50 ? '#ef4444' : '#10b981';

                // BPM Update
                const currentBPM = p.bpm + Math.floor(Math.random() * 3) + (p.stress > 0 ? 40 : 0);
                document.getElementById(`bpm-p${id}`).innerText = currentBPM;
                document.getElementById(`bpm-p${id}`).style.color = p.stress > 50 ? '#ef4444' : '#10b981';

                requestAnimationFrame(() => ECG.animate(id));
            },

            setStress: (id, level) => {
                // Level 0 = Normal, 100 = Heart Attack
                ECG.patients[id].stress = level;
                
                // Update UI Risk Meter
                const risk = 2 + (level > 0 ? 80 : 0) + Math.floor(Math.random() * 10);
                document.getElementById(`risk-txt-p${id}`).innerText = risk + "%";
                document.getElementById(`risk-bar-p${id}`).style.width = risk + "%";
                document.getElementById(`risk-bar-p${id}`).style.background = level > 0 ? '#ef4444' : '#10b981';
            }
        };

        /**
         * --------------------------------------------------------
         * 3. COMPUTER VISION ENGINE (MediaPipe)
         * --------------------------------------------------------
         */
        const VisionSys = {
            video: document.getElementById('video_feed'),
            canvas: document.getElementById('ai_overlay'),
            ctx: document.getElementById('ai_overlay').getContext('2d'),
            lastAction: "",

            start: async () => {
                const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
                hands.setOptions({maxNumHands: 2, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6});
                hands.onResults(VisionSys.onResults);

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                    VisionSys.video.srcObject = stream;
                    VisionSys.video.onloadedmetadata = () => {
                        VisionSys.video.play();
                        const camera = new Camera(VisionSys.video, {
                            onFrame: async () => { await hands.send({image: VisionSys.video}); },
                            width: 1280, height: 720
                        });
                        camera.start();
                    };
                } catch(e) { alert("Camera Permission Denied"); }
            },

            onResults: (results) => {
                const ctx = VisionSys.ctx;
                const w = VisionSys.canvas.width = VisionSys.video.videoWidth;
                const h = VisionSys.canvas.height = VisionSys.video.videoHeight;

                ctx.clearRect(0, 0, w, h);
                ctx.drawImage(results.image, 0, 0, w, h);
                
                // Divider
                ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h);
                ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.lineWidth = 2; ctx.stroke();

                if (results.multiHandLandmarks) {
                    for (const landmarks of results.multiHandLandmarks) {
                        drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#3b82f6', lineWidth: 3});
                        drawLandmarks(ctx, landmarks, {color: '#ef4444', lineWidth: 1});
                        
                        const bedId = landmarks[0].x < 0.5 ? 1 : 2;
                        VisionSys.detect(landmarks, bedId);
                    }
                }
            },

            detect: (lm, bedId) => {
                let fingers = [];
                [8, 12, 16, 20].forEach(t => fingers.push(lm[t].y < lm[t-2].y ? 1 : 0)); // Fingers
                fingers.unshift(Math.abs(lm[4].x - lm[17].x) > 0.15 ? 1 : 0); // Thumb

                const fStr = fingers.join("");
                let msg = "";

                // === EMERGENCY LOGIC ===
                // Fist (00000) = PAIN / HEART ATTACK
                if (fStr === "00000") msg = "CHEST PAIN";
                // Open Palm (11111) = HELP
                else if (fStr === "11111") msg = "NURSE HELP";
                // Victory (01100) = WATER
                else if (fStr === "01100") msg = "WATER";
                // Point (01000) = MEDS
                else if (fStr === "01000") msg = "MEDS";

                if (msg && msg !== VisionSys.lastAction) {
                    VisionSys.lastAction = msg;
                    PatientSys.updateStatus(bedId, msg);
                    setTimeout(() => VisionSys.lastAction = "", 2000); // Debounce
                }
            }
        };

        /**
         * --------------------------------------------------------
         * 4. PATIENT MANAGEMENT SYSTEM
         * --------------------------------------------------------
         */
        const PatientSys = {
            register: (id) => {
                if(VisionSys.video.readyState !== 4) return alert("Start AI First!");
                const tCanvas = document.createElement('canvas');
                tCanvas.width = 1280; tCanvas.height = 720;
                const tCtx = tCanvas.getContext('2d');
                tCtx.translate(1280, 0); tCtx.scale(-1, 1);
                tCtx.drawImage(VisionSys.video, 0, 0);
                document.getElementById(`img-p${id}`).src = tCanvas.toDataURL('image/png');
                alert(`Bed ${id} Registered!`);
            },

            updateStatus: (id, msg) => {
                const reqTxt = document.getElementById(`req-p${id}`);
                const badge = document.getElementById(`badge-p${id}`);
                const card = document.getElementById(`card-p${id}`);

                reqTxt.innerText = msg;

                // Highlight Legend
                document.querySelectorAll('.gesture-item').forEach(e=>e.classList.remove('active'));
                if(msg==="WATER") document.getElementById('leg-water').classList.add('active');
                if(msg==="CHEST PAIN") document.getElementById('leg-pain').classList.add('active');
                if(msg==="NURSE HELP") document.getElementById('leg-help').classList.add('active');

                // EMERGENCY LOGIC
                if(msg === "CHEST PAIN") {
                    // Spike ECG
                    ECG.setStress(id, 100);
                    
                    // UI Alerts
                    badge.className = "status-badge badge-danger";
                    badge.innerText = "HEART ATTACK RISK";
                    card.className = "patient-card emergency";
                    
                    // Notification
                    UI.notify("CRITICAL ALERT", `Bed ${id}: Heart Attack Risk Detected!`, true);
                } else if (msg === "NURSE HELP") {
                    badge.className = "status-badge badge-danger";
                    badge.innerText = "EMERGENCY";
                    card.className = "patient-card";
                    ECG.setStress(id, 0); // Normal ECG
                    UI.notify("Nurse Call", `Bed ${id} needs assistance`, false);
                } else {
                    // Normal Requests
                    badge.className = "status-badge badge-safe";
                    badge.innerText = "REQUESTING";
                    card.className = "patient-card";
                    ECG.setStress(id, 0); // Normal ECG
                    UI.notify("Patient Request", `Bed ${id}: ${msg}`, false);
                }
            }
        };

        const UI = {
            notify: (title, msg, isCritical) => {
                const toast = document.getElementById('toast');
                const tTitle = document.getElementById('toast-title');
                const tMsg = document.getElementById('toast-msg');

                tTitle.innerText = title;
                tMsg.innerText = msg;
                
                toast.className = isCritical ? "toast show danger" : "toast show";
                
                // Speak
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(msg));

                setTimeout(() => toast.classList.remove('show'), 5000);
            }
        };
    </script>
</body>
</html>
