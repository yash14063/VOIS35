<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare Enterprise | Titan OS</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* ==========================================================================
           MODULE 1: MEDI-UI PRO FRAMEWORK
           ========================================================================== */
        :root {
            --c-bg-app: #020617;
            --c-bg-sidebar: #0f172a;
            --c-bg-panel: #1e293b;
            --c-bg-card: #334155;
            --c-primary: #6366f1;
            --c-primary-hover: #4f46e5;
            --c-accent: #06b6d4;
            --c-success: #10b981;
            --c-warning: #f59e0b;
            --c-danger: #ef4444;
            --c-text-main: #f8fafc;
            --c-text-muted: #94a3b8;
            --border: 1px solid rgba(255,255,255,0.08);
            --radius-md: 12px;
            --radius-lg: 16px;
            --header-h: 70px;
            --sidebar-w: 280px;
        }

        body.hc-mode {
            --c-bg-app: #000; --c-bg-sidebar: #000; --c-bg-panel: #000;
            --c-primary: #ff0; --c-accent: #0ff; --c-text-main: #fff;
            --border: 2px solid #fff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Inter', sans-serif; background: var(--c-bg-app); color: var(--c-text-main); height: 100vh; display: flex; overflow: hidden; }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        /* AUTH SCREEN */
        #auth-layer { position: fixed; inset: 0; z-index: 9999; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%); display: flex; align-items: center; justify-content: center; }
        .auth-box { width: 400px; padding: 40px; background: rgba(30,41,59,0.9); border: var(--border); border-radius: 24px; text-align: center; backdrop-filter: blur(10px); }
        .form-control { width: 100%; padding: 12px; margin: 10px 0; background: #020617; border: var(--border); color: white; border-radius: 12px; text-align: center; }
        .btn-primary { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--c-primary), var(--c-accent)); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 15px; }

        /* LAYOUT */
        aside { width: var(--sidebar-w); background: var(--c-bg-sidebar); border-right: var(--border); display: flex; flex-direction: column; padding: 24px; z-index: 50; }
        .brand { font-size: 1.4rem; font-weight: 800; color: var(--c-text-main); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 16px; margin-bottom: 5px; border-radius: var(--radius-md); color: var(--c-text-muted); cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.15); color: var(--c-primary); border-left: 3px solid var(--c-primary); }

        main { flex: 1; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        header { height: var(--header-h); border-bottom: var(--border); padding: 0 32px; display: flex; align-items: center; justify-content: space-between; background: rgba(15, 23, 42, 0.95); }
        
        .viewport { flex: 1; padding: 24px; overflow-y: auto; }
        .page-view { display: none; height: 100%; flex-direction: column; gap: 24px; animation: fadeIn 0.4s ease; }
        .page-view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD COMPONENTS */
        .dash-grid { display: grid; grid-template-columns: 2.5fr 1fr; grid-template-rows: 55% 45%; gap: 24px; height: 100%; }
        
        /* Camera */
        .cam-widget { grid-column: 1 / 2; grid-row: 1 / 2; background: #000; border-radius: var(--radius-lg); border: 2px solid var(--border); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        video { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); z-index: 10; }
        
        .hud-overlay { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 12px; border-radius: 8px; border: var(--border); font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--c-success); z-index: 20; min-width: 200px; pointer-events: none; }
        .hud-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        .cam-controls { position: absolute; bottom: 20px; z-index: 30; display: flex; gap: 12px; background: rgba(15, 23, 42, 0.9); padding: 8px; border-radius: 40px; border: var(--border); }
        .btn-icon { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.2s; font-weight: bold; font-size: 0.85rem; }
        .btn-icon:hover { background: var(--c-primary); border-color: var(--c-primary); }

        /* Side Panel */
        .side-stack { grid-column: 2 / 3; grid-row: 1 / 3; display: flex; flex-direction: column; gap: 20px; }
        .twin-box { flex: 1; background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 100%); border-radius: var(--radius-lg); border: 1px solid var(--c-accent); position: relative; overflow: hidden; }
        .twin-label { position: absolute; top: 10px; left: 10px; color: var(--c-accent); font-weight: bold; font-size: 0.75rem; background: rgba(0,0,0,0.7); padding: 4px; z-index: 10; }
        
        /* Enhanced Digital Twin Panel */
        .twin-stats { position: absolute; bottom: 10px; left: 10px; right: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; z-index: 10; }
        .twin-stat { background: rgba(0,0,0,0.8); padding: 8px; border-radius: 6px; border: 1px solid rgba(6,182,212,0.3); text-align: center; }
        .twin-stat-label { font-size: 0.6rem; color: var(--c-text-muted); text-transform: uppercase; }
        .twin-stat-value { font-size: 0.85rem; color: var(--c-accent); font-weight: bold; font-family: 'JetBrains Mono'; }
        
        .legend-card { flex: 1; background: var(--c-bg-card); border-radius: var(--radius-lg); border: var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .g-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255,255,255,0.03); margin: 8px; border-radius: 8px; border: 1px solid transparent; transition: 0.2s; }
        .g-item.active { border-color: var(--c-accent); background: rgba(6, 182, 212, 0.15); transform: translateX(5px); }

        /* Patient Grid */
        .patient-row { grid-column: 1 / 3; grid-row: 2 / 3; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .p-card { background: var(--c-bg-card); border-radius: var(--radius-lg); border: var(--border); padding: 20px; display: flex; flex-direction: column; position: relative; transition: 0.3s; }
        .p-card.alert { border-color: var(--c-danger); box-shadow: 0 0 30px rgba(239, 68, 68, 0.3); }
        
        .p-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .p-profile { display: flex; gap: 12px; align-items: center; }
        .p-img { width: 56px; height: 56px; border-radius: 12px; background: #334155; object-fit: cover; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .badge-ok { background: rgba(16, 185, 129, 0.15); color: var(--c-success); }
        .badge-crit { background: rgba(239, 68, 68, 0.15); color: var(--c-danger); animation: pulse 1s infinite; }

        .ecg-container { flex: 1; background: #000; border-radius: 8px; border: var(--border); position: relative; overflow: hidden; margin-bottom: 12px; display: flex; flex-direction: column; }
        .ecg-canvas { width: 100%; height: 100%; }
        
        .pc-controls { display: flex; gap: 10px; align-items: center; }
        .ctrl-btn { width: 40px; height: 40px; border-radius: 10px; background: var(--c-bg-sidebar); border: var(--border); color: var(--c-text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .ctrl-btn.active { background: var(--c-warning); color: #000; border-color: var(--c-warning); }
        .ctrl-btn.spin i { animation: spin 1s linear infinite; }

        /* Analytics & Chat */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; height: 100%; }
        .chart-wrap { background: var(--c-bg-card); border-radius: var(--radius-lg); border: var(--border); padding: 20px; }
        
        .chat-layout { display: flex; height: 100%; gap: 24px; }
        .chat-sidebar { width: 260px; background: var(--c-bg-card); border-radius: var(--radius-lg); border: var(--border); padding: 10px; }
        .chat-main { flex: 1; background: var(--c-bg-card); border-radius: var(--radius-lg); border: var(--border); display: flex; flex-direction: column; }
        .msg-list { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 10px 16px; border-radius: 12px; max-width: 70%; font-size: 0.9rem; }
        .msg.in { background: var(--c-bg-input); align-self: flex-start; }
        .msg.out { background: var(--c-primary); color: white; align-self: flex-end; }

        /* Toast */
        .toast-container { position: fixed; top: 24px; right: 24px; z-index: 11000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { width: 320px; padding: 16px; background: white; color: #000; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: flex-start; gap: 12px; transform: translateX(120%); transition: 0.4s; border-left: 5px solid var(--c-primary); pointer-events: auto; }
        .toast.show { transform: translateX(0); }
        .toast.danger { border-left-color: var(--c-danger); background: #fee2e2; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="auth-box">
            <i class="fas fa-heart-pulse" style="font-size: 4rem; color: var(--c-primary); margin-bottom: 20px;"></i>
            <h2 style="color:white; margin-bottom:10px;">VisionCare Titan OS</h2>
            <p style="color:var(--c-text-muted); margin-bottom: 30px;">Medical Command Center</p>
            <input type="text" id="auth-user" class="form-control" placeholder="admin" value="admin">
            <input type="password" id="auth-pass" class="form-control" placeholder="admin123" value="admin123">
            <button class="btn-primary" onclick="Sys.login()">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <div id="app-shell" style="display:none; width:100%; height:100%; display:flex;">
        <aside>
            <div class="brand"><i class="fas fa-eye text-primary"></i> VisionCare</div>
            <div class="nav-item active" onclick="Router.go('dashboard')"><i class="fas fa-desktop"></i> Monitor</div>
            <div class="nav-item" onclick="Router.go('analytics')"><i class="fas fa-chart-line"></i> Analytics</div>
            <div class="nav-item" onclick="Router.go('chat')"><i class="fas fa-comments"></i> Chat</div>
            <div class="nav-item" onclick="Router.go('logs')"><i class="fas fa-clipboard-list"></i> Logs</div>
            <div class="nav-item" onclick="Router.go('settings')"><i class="fas fa-cog"></i> Settings</div>
            <div style="margin-top:auto">
                <div class="nav-item text-danger" onclick="location.reload()"><i class="fas fa-power-off"></i> Reboot</div>
            </div>
        </aside>

        <main>
            <header>
                <div>
                    <h2 class="font-bold text-lg">ICU Ward 104</h2>
                    <div class="text-sm text-muted" id="clock">00:00:00 AM</div>
                </div>
                <div style="display:flex; align-items:center; gap:15px;">
                    <span class="badge badge-success">‚óè ONLINE</span>
                    <div style="text-align:right;">
                        <div class="font-bold">Dr. Admin</div>
                        <div class="text-xs text-muted">Chief Medical Officer</div>
                    </div>
                </div>
            </header>

            <div class="viewport">
                
                <div id="view-dashboard" class="page-view active">
                    <div class="dash-grid">
                        
                        <div class="cam-widget">
                            <video id="vid" playsinline muted></video>
                            <canvas id="can"></canvas>
                            
                            <div class="hud-overlay">
                                <div class="hud-item"><span>AI Status:</span> <span class="text-success" id="ai-stat">WAITING</span></div>
                                <div class="hud-item"><span>Bed 1 (L):</span> <span id="debug-b1">--</span></div>
                                <div class="hud-item"><span>Bed 2 (R):</span> <span id="debug-b2">--</span></div>
                                <div class="hud-item" style="border-top:1px solid #333; margin-top:5px; padding-top:5px;">
                                    <span>CMD:</span> <span id="debug-cmd" class="text-warning">--</span>
                                </div>
                            </div>

                            <div class="cam-controls">
                                <button class="btn-icon" onclick="Patient.snap(1)">üì∏ Bed 1</button>
                                <button class="btn-icon" style="background:var(--c-primary)" onclick="Vision.start()">‚ñ∂ START AI</button>
                                <button class="btn-icon" onclick="Voice.toggle()">üéôÔ∏è Voice</button>
                                <button class="btn-icon" onclick="Patient.snap(2)">üì∏ Bed 2</button>
                            </div>
                        </div>

                        <div class="side-stack">
                            <div class="twin-box">
                                <canvas id="twin_can" style="width:100%; height:100%;"></canvas>
                                <div class="twin-label">DIGITAL TWIN</div>
                                <div class="twin-stats">
                                    <div class="twin-stat">
                                        <div class="twin-stat-label">Height</div>
                                        <div class="twin-stat-value" id="twin-height">--</div>
                                    </div>
                                    <div class="twin-stat">
                                        <div class="twin-stat-label">Pose Score</div>
                                        <div class="twin-stat-value" id="twin-score">--</div>
                                    </div>
                                    <div class="twin-stat">
                                        <div class="twin-stat-label">Activity</div>
                                        <div class="twin-stat-value" id="twin-activity">--</div>
                                    </div>
                                </div>
                            </div>
                            <div class="legend-card">
                                <div style="padding:15px; font-weight:bold; color:var(--c-text-muted);">GESTURE MAP</div>
                                <div class="g-item" id="g-pain"><span class="g-icon">‚úä</span> <div><strong>Fist</strong><br><small>Emergency</small></div></div>
                                <div class="g-item" id="g-water"><span class="g-icon">‚úåÔ∏è</span> <div><strong>V-Sign</strong><br><small>Water</small></div></div>
                                <div class="g-item" id="g-fan"><span class="g-icon">üëå</span> <div><strong>Pinch</strong><br><small>Fan On</small></div></div>
                            </div>
                        </div>

                        <div class="patient-row">
                            <div class="p-card" id="card-p1">
                                <div class="p-header">
                                    <div class="p-profile">
                                        <img id="img-p1" src="https://via.placeholder.com/60" class="p-img">
                                        <div><h4>YASH SAOKHEDE</h4><div class="text-xs text-muted">Bed 1 ‚Ä¢ Cardiac</div></div>
                                    </div>
                                    <span class="badge badge-success" id="bdg-p1">STABLE</span>
                                </div>
                                <div class="ecg-container"><canvas id="ecg-p1"></canvas></div>
                                <div class="text-center font-bold text-xl mb-4" id="req-p1">--</div>
                                <div class="pc-controls">
                                    <div class="ctrl-btn" id="btn-light-p1"><i class="fas fa-lightbulb"></i></div>
                                    <div class="ctrl-btn" id="btn-fan-p1"><i class="fas fa-fan"></i></div>
                                    <div style="flex:1;"></div>
                                    <button class="btn-icon" style="border:1px solid #555" onclick="alert('Generate QR')"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </div>

                            <div class="p-card" id="card-p2">
                                <div class="p-header">
                                    <div class="p-profile">
                                        <img id="img-p2" src="https://via.placeholder.com/60" class="p-img">
                                        <div><h4>Ruchi Jadhav</h4><div class="text-xs text-muted">Bed 2 ‚Ä¢ Ortho</div></div>
                                    </div>
                                    <span class="badge badge-success" id="bdg-p2">STABLE</span>
                                </div>
                                <div class="ecg-container"><canvas id="ecg-p2"></canvas></div>
                                <div class="text-center font-bold text-xl mb-4" id="req-p2">--</div>
                                <div class="pc-controls">
                                    <div class="ctrl-btn" id="btn-light-p2"><i class="fas fa-lightbulb"></i></div>
                                    <div class="ctrl-btn" id="btn-fan-p2"><i class="fas fa-fan"></i></div>
                                    <div style="flex:1;"></div>
                                    <button class="btn-icon" style="border:1px solid #555" onclick="alert('Generate QR')"><i class="fas fa-qrcode"></i></button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div id="view-analytics" class="page-view">
                    <h2 class="mb-4">Real-Time Analytics</h2>
                    <div class="analytics-grid">
                        <div class="chart-wrap">
                            <canvas id="chart-requests"></canvas>
                        </div>
                        <div class="chart-wrap">
                            <canvas id="chart-urgency"></canvas>
                        </div>
                    </div>
                </div>

                <div id="view-chat" class="page-view">
                    <div class="chat-layout">
                        <div class="chat-sidebar">
                            <div class="p-4 font-bold border-b border-gray-700">Active Staff</div>
                            <div style="padding:15px; cursor:pointer; background:rgba(255,255,255,0.05); margin-top:10px;">Nurse Station</div>
                            <div style="padding:15px; cursor:pointer;">Pharmacy</div>
                        </div>
                        <div class="chat-main">
                            <div class="msg-list" id="msg-list">
                                <div class="msg in">Dr. Admin, check Bed 1 ECG.</div>
                                <div class="msg out">Copy. AI is tracking.</div>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="chat-input" class="form-control" placeholder="Type message..." style="margin:0;">
                                <button class="btn-primary" style="margin:0;" onclick="Chat.send()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-logs" class="page-view">
                    <div class="card h-full">
                        <div class="card-header"><span class="card-title">Event Logs</span> <button class="btn-outline btn" onclick="DB.clear()">Clear</button></div>
                        <div class="card-body p-0">
                            <table style="width:100%; border-collapse:collapse;">
                                <thead style="background:rgba(0,0,0,0.2); border-bottom:1px solid #333; text-align:left;">
                                    <tr><th style="padding:15px;">Time</th><th>Source</th><th>Event</th><th>Type</th></tr>
                                </thead>
                                <tbody id="log-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-settings" class="page-view">
                    <div class="card">
                        <div class="card-header">System Settings</div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Voice Volume</label>
                                <input type="range" class="form-range" onchange="Voice.vol=this.value" min="0" max="1" step="0.1">
                            </div>
                            <div class="form-group">
                                <label>Theme</label>
                                <button class="btn-primary" onclick="document.body.classList.toggle('hc-mode')">Toggle High Contrast</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="toast-area" class="toast-container"></div>

    <script>
        // CONSTANTS
        const VIDEO = document.getElementById('vid');
        const CANVAS = document.getElementById('can');
        const CTX = CANVAS.getContext('2d');
        const TWIN_CTX = document.getElementById('twin_can').getContext('2d');
        
        let lastAction1 = "";
        let lastAction2 = "";

        // --- 1. SYSTEM KERNEL ---
        const Sys = {
            login: () => {
                document.getElementById('auth-layer').style.display='none';
                document.getElementById('app-shell').style.display='flex';
                Voice.speak("Vision Care Titan System Online");
                DB.init();
                ECG.init(1); ECG.init(2);
                Charts.init();
            },
            notify: (title, msg, isCrit) => {
                const area = document.getElementById('toast-area');
                const t = document.createElement('div');
                t.className = `toast ${isCrit ? 'danger' : ''}`;
                t.innerHTML = `<div style="font-size:1.5rem">${isCrit?'üö®':'üîî'}</div><div><strong>${title}</strong><br><small>${msg}</small></div>`;
                area.appendChild(t);
                setTimeout(()=>t.classList.add('show'), 10);
                setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 400); }, 4000);
                Voice.speak(msg);
                DB.log(title, msg, isCrit?'CRIT':'INFO');
            }
        };

        const Router = {
            go: (view) => {
                document.querySelectorAll('.page-view').forEach(e => e.classList.remove('active'));
                document.getElementById(`view-${view}`).classList.add('active');
                Voice.speak(`Opening ${view}`);
            }
        };

        // --- 2. ENHANCED DIGITAL TWIN & VISION KERNEL ---
        const Twin = {
            lastPose: null,
            updateStats: (pose) => {
                if(!pose) return;
                // Calculate body height from pose landmarks (nose to ankle)
                const nose = pose[0];
                const leftAnkle = pose[27];
                const rightAnkle = pose[28];
                
                if(nose && leftAnkle) {
                    const heightPx = Math.abs(nose.y - leftAnkle.y) * VIDEO.videoHeight;
                    const heightCm = Math.round(heightPx / 10 * 1.8);
                    document.getElementById('twin-height').innerText = heightCm + ' cm';
                }
                
                // Calculate pose detection confidence score
                const visible = pose.filter(p => p && p.x > 0 && p.x < 1 && p.y > 0 && p.y < 1).length;
                const score = Math.round((visible / 33) * 100);
                document.getElementById('twin-score').innerText = score + '%';
                
                // Determine activity level based on movement
                let activity = 'Still';
                if(Twin.lastPose) {
                    const moved = Math.abs(pose[10].y - Twin.lastPose[10].y) + Math.abs(pose[11].y - Twin.lastPose[11].y);
                    if(moved > 0.08) activity = 'Active';
                    else if(moved > 0.04) activity = 'Moving';
                    else if(moved > 0.02) activity = 'Restless';
                }
                document.getElementById('twin-activity').innerText = activity;
                Twin.lastPose = [...pose];
            }
        };

        const Vision = {
            start: async () => {
                document.getElementById('ai-stat').innerText = "LOADING...";
                const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
                holistic.setOptions({maxNumHands: 2, minDetectionConfidence: 0.5});
                holistic.onResults(Vision.process);

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                    VIDEO.srcObject = stream;
                    VIDEO.onloadedmetadata = () => { VIDEO.play(); document.getElementById('ai-stat').innerText = "ACTIVE"; const cam = new Camera(VIDEO, { onFrame: async () => { await holistic.send({image: VIDEO}); }, width: 1280, height: 720 }); cam.start(); };
                } catch(e) { alert("Camera Access Denied"); }
            },
            process: (results) => {
                // Draw main camera view
                CANVAS.width = VIDEO.videoWidth; CANVAS.height = VIDEO.videoHeight;
                const w = CANVAS.width; const h = CANVAS.height;
                CTX.clearRect(0,0,w,h); CTX.drawImage(results.image, 0, 0, w, h);
                
                // Center splitter line
                CTX.beginPath(); CTX.moveTo(w/2,0); CTX.lineTo(w/2,h); CTX.strokeStyle="rgba(255,255,255,0.5)"; CTX.lineWidth=3; CTX.stroke();
                
                // Enhanced Hands with landmarks
                if(results.leftHandLandmarks) {
                    drawConnectors(CTX, results.leftHandLandmarks, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 3});
                    drawLandmarks(CTX, results.leftHandLandmarks, {color: '#818cf8', lineWidth: 2, radius: 3});
                    Vision.logic(results.leftHandLandmarks);
                }
                if(results.rightHandLandmarks) {
                    drawConnectors(CTX, results.rightHandLandmarks, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 3});
                    drawLandmarks(CTX, results.rightHandLandmarks, {color: '#818cf8', lineWidth: 2, radius: 3});
                    Vision.logic(results.rightHandLandmarks);
                }

                // Enhanced Digital Twin with glow effects
                const tCan = document.getElementById('twin_can'); tCan.width=w; tCan.height=h;
                TWIN_CTX.clearRect(0,0,w,h);
                
                if(results.poseLandmarks) {
                    // Draw glow effect for body
                    TWIN_CTX.shadowColor = '#22d3ee';
                    TWIN_CTX.shadowBlur = 20;
                    drawConnectors(TWIN_CTX, results.poseLandmarks, POSE_CONNECTIONS, {color:'#06b6d4', lineWidth: 6});
                    TWIN_CTX.shadowBlur = 0;
                    
                    // Draw body joints with highlight
                    drawLandmarks(TWIN_CTX, results.poseLandmarks, {
                        color: '#22d3ee',
                        lineWidth: 2,
                        radius: 5,
                        fillColor: '#0891b2'
                    });
                    
                    // Update twin stats
                    Twin.updateStats(results.poseLandmarks);
                }
            },
            logic: (lm) => {
                const x = lm[0].x; // Wrist X
                const bedId = x < 0.5 ? 1 : 2; // Left = Bed 1, Right = Bed 2
                
                let fingers = 0;
                if(lm[8].y < lm[6].y) fingers++;
                if(lm[12].y < lm[10].y) fingers++;
                if(lm[16].y < lm[14].y) fingers++;
                if(lm[20].y < lm[18].y) fingers++;
                if(Math.abs(lm[4].x - lm[5].x) > 0.05) fingers++;

                const isPinch = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y) < 0.05;

                document.getElementById(`debug-b${bedId}`).innerText = fingers;

                let msg = "";
                if(isPinch) msg = "FAN ON";
                else if(fingers === 0) msg = "PAIN";
                else if(fingers === 2) msg = "WATER";
                else if(fingers === 5) msg = "LIGHT ON";

                // Debounce Logic per Bed
                if(bedId === 1 && msg && msg !== lastAction1) {
                    lastAction1 = msg; RoomMgr.trigger(1, msg); setTimeout(()=>lastAction1="", 2000);
                }
                if(bedId === 2 && msg && msg !== lastAction2) {
                    lastAction2 = msg; RoomMgr.trigger(2, msg); setTimeout(()=>lastAction2="", 2000);
                }
            }
        };

        // --- 3. ROOM & ECG ---
        const RoomMgr = {
            lastNotify: { 1: { msg: "", time: 0 }, 2: { msg: "", time: 0 } },
            trigger: (id, msg) => {
                const now = Date.now();
                const cooldown = 3000; // 3 seconds cooldown between same notifications
                
                // Check if same message was shown within cooldown period
                if(RoomMgr.lastNotify[id].msg === msg && (now - RoomMgr.lastNotify[id].time) < cooldown) {
                    // Skip notification if within cooldown
                    document.getElementById(`req-p${id}`).innerText = msg;
                    return;
                }
                
                // Update last notification info
                RoomMgr.lastNotify[id] = { msg: msg, time: now };
                
                document.getElementById(`req-p${id}`).innerText = msg;
                if(msg === "PAIN") {
                    document.getElementById(`card-p${id}`).classList.add('alert');
                    document.getElementById(`bdg-p${id}`).className = "badge badge-crit";
                    document.getElementById(`bdg-p${id}`).innerText = "CRITICAL";
                    Sys.notify(`BED ${id}`, "EMERGENCY: PAIN DETECTED", true);
                } else {
                    if(msg.includes("FAN")) document.getElementById(`btn-fan-p${id}`).classList.add('active', 'spin');
                    if(msg.includes("LIGHT")) document.getElementById(`btn-light-p${id}`).classList.add('active');
                    Sys.notify(`Bed ${id}`, `Request: ${msg}`, false);
                }
            }
        };

        const ECG = {
            init: (id) => {
                const c = document.getElementById(`ecg-p${id}`); const ctx = c.getContext('2d');
                c.width = c.offsetWidth; c.height = c.offsetHeight;
                let x = 0; ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0, c.height/2);
                
                // P-QRS-T Simulation
                const draw = () => {
                    x += 2;
                    if(x > c.width) { x = 0; ctx.clearRect(0,0,c.width,c.height); ctx.beginPath(); ctx.moveTo(0,c.height/2); }
                    
                    let y = c.height/2;
                    // Heartbeat Logic
                    if(x % 100 > 10 && x % 100 < 15) y -= 5; // P
                    else if(x % 100 > 20 && x % 100 < 25) y += 5; // Q
                    else if(x % 100 > 25 && x % 100 < 35) y -= 40; // R (Spike)
                    else if(x % 100 > 35 && x % 100 < 40) y += 15; // S
                    else if(x % 100 > 50 && x % 100 < 65) y -= 8; // T
                    
                    // Jitter
                    y += (Math.random() - 0.5) * 2;

                    ctx.lineTo(x, y); ctx.stroke();
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        // --- 4. VOICE & CHAT ---
        const Voice = {
            vol: 1,
            speak: (txt) => { const u = new SpeechSynthesisUtterance(txt); u.volume = Voice.vol; window.speechSynthesis.speak(u); },
            toggle: () => {
                const R = window.SpeechRecognition || window.webkitSpeechRecognition;
                const r = new R(); r.lang = 'en-US'; r.start();
                r.onresult = (e) => {
                    const t = e.results[0][0].transcript.toLowerCase();
                    Sys.notify("Voice", t, false);
                    if(t.includes("analytics")) Router.go('analytics');
                    if(t.includes("dashboard")) Router.go('dashboard');
                    if(t.includes("logs")) Router.go('logs');
                }
            }
        };

        const Chat = {
            send: () => {
                const i = document.getElementById('chat-input');
                const list = document.getElementById('msg-list');
                if(i.value) {
                    list.innerHTML += `<div class="msg out">${i.value}</div>`;
                    i.value="";
                    setTimeout(()=> list.innerHTML += `<div class="msg in">Acknowledged.</div>`, 1000);
                }
            }
        };

        const Patient = {
            snap: (id) => {
                const c = document.createElement('canvas'); c.width=1280; c.height=720;
                c.getContext('2d').drawImage(VIDEO,0,0);
                document.getElementById(`img-p${id}`).src = c.toDataURL('image/png');
                Voice.speak(`Bed ${id} Registered`);
            }
        };

        const DB = {
            init: () => {
                if(!localStorage.getItem('vc_logs')) localStorage.setItem('vc_logs', JSON.stringify([]));
                DB.render();
            },
            log: (src, evt, type) => {
                const l = JSON.parse(localStorage.getItem('vc_logs'));
                l.unshift({time: new Date().toLocaleTimeString(), src, evt, type});
                localStorage.setItem('vc_logs', JSON.stringify(l));
                DB.render();
            },
            render: () => {
                const l = JSON.parse(localStorage.getItem('vc_logs'));
                document.getElementById('log-body').innerHTML = l.map(x => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.1)">
                        <td style="padding:10px; color:var(--c-accent)">${x.time}</td>
                        <td>${x.src}</td><td>${x.evt}</td>
                        <td><span class="badge ${x.type==='CRIT'?'badge-crit':'badge-ok'}">${x.type}</span></td>
                    </tr>`).join('');
            },
            clear: () => { localStorage.setItem('vc_logs', JSON.stringify([])); DB.render(); }
        };

        const Charts = {
            init: () => {
                new Chart(document.getElementById('chart-requests'), {
                    type: 'doughnut',
                    data: { 
                        labels: ['Pain', 'Meds', 'Water', 'Fan'], 
                        datasets: [{ 
                            data: [5, 12, 15, 8], 
                            backgroundColor: ['#ef4444', '#6366f1', '#06b6d4', '#f59e0b'],
                            borderWidth: 0
                        }] 
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#f8fafc', padding: 20 } },
                            title: { display: true, text: 'Patient Requests', color: '#f8fafc', font: { size: 16 } }
                        }
                    }
                });
                new Chart(document.getElementById('chart-urgency'), {
                    type: 'line',
                    data: { 
                        labels: ['10AM', '11AM', '12PM', '1PM'], 
                        datasets: [{ 
                            label: 'Avg Response (s)', 
                            data: [45, 30, 20, 25], 
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#6366f1'
                        }] 
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                            x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#f8fafc' } },
                            title: { display: true, text: 'Response Time Trends', color: '#f8fafc', font: { size: 16 } }
                        }
                    }
                });
            }
        };

        // START CLOCK
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
    </script>
</body>
</html>
