<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare Enterprise | Central Command</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        :root {
            --bg-deep: #050b14;
            --bg-panel: #0f172a;
            --bg-card: #1e293b;
            --primary: #6366f1;
            --accent: #38bdf8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: 1px solid rgba(255,255,255,0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; outline: none; user-select: none; }
        body { font-family: 'Space Grotesk', sans-serif; background: var(--bg-deep); color: var(--text-main); margin: 0; height: 100vh; overflow: hidden; display: flex; }

        #loader { position: fixed; inset: 0; background: #000; z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease; }
        .spinner { width: 60px; height: 60px; border: 5px solid #333; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }

        aside { width: 260px; background: var(--bg-panel); border-right: var(--border); padding: 20px; display: flex; flex-direction: column; z-index: 50; }
        .brand { font-size: 1.5rem; font-weight: bold; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; color: white; }
        .nav-item { padding: 12px; color: var(--text-muted); border-radius: 10px; margin-bottom: 5px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.15); color: var(--primary); border-left: 3px solid var(--primary); }

        main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; position: relative; }

        .dash-grid { display: grid; grid-template-rows: 60% 40%; gap: 20px; height: 100%; }
        .top-row { display: grid; grid-template-columns: 2fr 1.2fr; gap: 20px; height: 100%; }

        .cam-box { background: #000; border-radius: var(--radius); border: var(--border); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        video { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); z-index: 10; }
        
        .hud { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; font-family: 'JetBrains Mono'; font-size: 0.8rem; color: var(--success); border: var(--border); pointer-events: none; z-index: 20; min-width: 180px; }
        .hud-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        .split-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.3); z-index: 15; border-left: 2px dashed rgba(0,0,0,0.5); }
        .zone-label { position: absolute; top: 10px; font-weight: bold; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; z-index: 15; }
        
        .p-card { background: var(--bg-card); border-radius: var(--radius); border: var(--border); padding: 15px; display: flex; flex-direction: column; transition: 0.3s; position: relative; }
        .p-card.danger { border-color: var(--danger); box-shadow: 0 0 40px rgba(239, 68, 68, 0.4); animation: flashRed 1s infinite; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .badge.ok { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge.crit { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

        .ecg-area { flex: 1; background: #000; border-radius: 8px; margin-bottom: 10px; position: relative; overflow: hidden; border: var(--border); min-height: 80px; }
        .saline-area { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .saline-track { flex: 1; height: 8px; background: #000; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
        .saline-fill { height: 100%; background: var(--accent); width: 100%; transition: 1s linear; }

        .btn-sq { width: 40px; height: 40px; border-radius: 8px; background: var(--bg-panel); border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .btn-sq.active { background: var(--warning); color: #000; border-color: var(--warning); }
        .btn-sq.spin i { animation: spin 1s linear infinite; }

        /* NEW FEATURE STYLES */
        .twinning-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .twin-box { background: #000; border: 1px solid #333; height: 100px; border-radius: 8px; position: relative; overflow: hidden; }
        .face-tag { position: absolute; top: 5px; right: 5px; font-size: 0.5rem; background: var(--primary); padding: 2px 4px; border-radius: 3px; }
        .report-table { width: 100%; font-size: 0.75rem; margin-top: 10px; border-collapse: collapse; }
        .report-table td { padding: 5px; border-bottom: 1px solid #222; }
        .risk-high { color: var(--danger); font-weight: bold; }

        .toast { position: fixed; top: 20px; right: 20px; background: white; color: #000; padding: 15px 25px; border-radius: 12px; z-index: 30000; transform: translateX(150%); transition: 0.4s; border-left: 5px solid var(--primary); font-weight: bold; }
        .toast.show { transform: translateX(0); }
        .toast.danger { border-left-color: var(--danger); background: #fee2e2; color: #991b1b; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes flashRed { 0% { border-color: var(--danger); } 50% { border-color: transparent; } 100% { border-color: var(--danger); } }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
    </style>
</head>
<body>

    <div id="loader" style="display:none;">
        <div class="spinner"></div>
        <h3 style="color:white;">Initializing Neural Engine...</h3>
    </div>

    <div id="auth-layer" style="position:fixed; inset:0; background:#000; z-index:10000; display:flex; align-items:center; justify-content:center;">
        <div style="width:400px; padding:40px; background:var(--bg-panel); border-radius:24px; text-align:center; border:1px solid #333;">
            <h2 style="color:white;">VisionCare Ultimate</h2>
            <p style="color:gray;">Command Center Login</p>
            <input type="text" id="u" value="admin" style="width:100%; padding:10px; margin-bottom:10px; background:#000; border:1px solid #333; color:white; text-align:center; border-radius:8px;">
            <input type="password" id="p" value="admin123" style="width:100%; padding:10px; margin-bottom:20px; background:#000; border:1px solid #333; color:white; text-align:center; border-radius:8px;">
            <button onclick="System.login()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <div id="app-shell" style="display:none; width:100%; height:100%;">
        <aside>
            <div class="brand"><i class="fas fa-eye text-primary"></i> VisionCare</div>
            <div class="nav-item active" onclick="Router.go('dash')"><i class="fas fa-desktop"></i> Monitor</div>
            <div class="nav-item" onclick="Router.go('analytics')"><i class="fas fa-chart-line"></i> Analytics</div>
            <div class="nav-item" onclick="Router.go('logs')"><i class="fas fa-clipboard-list"></i> Logs</div>
            <div style="margin-top:auto">
                <div style="font-size:0.7rem; color:gray; font-weight:bold;">VOICE STATUS</div>
                <div id="mic-status" style="color:var(--danger); font-weight:bold;">OFFLINE</div>
            </div>
        </aside>

        <main>
            <div id="view-dash" class="view-section active">
                <div class="dash-grid">
                    <div class="top-row">
                        <div class="cam-box">
                            <video id="vid" playsinline muted></video>
                            <canvas id="can"></canvas>
                            <div class="split-line"></div>
                            <div class="zone-label" style="left:10px; color:var(--accent);">BED 1</div>
                            <div class="zone-label" style="right:10px; color:var(--accent);">BED 2</div>
                            <div class="hud">
                                <div class="hud-row"><span>AI CORE:</span> <span id="ai-stat">WAITING</span></div>
                                <div class="hud-row"><span>CMD:</span> <span id="debug-cmd" style="color:yellow">--</span></div>
                            </div>
                        </div>
                        
                        <div style="background:var(--bg-card); border-radius:12px; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                            <div>
                                <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:0.8rem;">FACE REGISTRY</h4>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <img src="https://ui-avatars.com/api/?name=P1&background=6366f1&color=fff" style="width:35px; border-radius:50%; border:2px solid var(--success);">
                                    <img src="https://ui-avatars.com/api/?name=P2&background=38bdf8&color=fff" style="width:35px; border-radius:50%; border:2px solid var(--success);">
                                    <button onclick="System.registerFace()" style="flex:1; background:transparent; border:1px solid var(--primary); color:var(--primary); border-radius:5px; font-size:0.6rem; cursor:pointer; padding:5px;">SCAN</button>
                                </div>
                            </div>

                            <div>
                                <h4 style="margin:0 0 10px 0; color:var(--accent); font-size:0.8rem;">BODY TWINNING</h4>
                                <div class="twinning-grid">
                                    <div class="twin-box"><canvas id="twin-1"></canvas><span class="face-tag">B-1</span></div>
                                    <div class="twin-box"><canvas id="twin-2"></canvas><span class="face-tag">B-2</span></div>
                                </div>
                            </div>

                            <div>
                                <h4 style="margin:0 0 5px 0; color:var(--danger); font-size:0.8rem;">CARDIAC PREDICTION</h4>
                                <table class="report-table">
                                    <tr><td>BED 1</td><td>Risk: <span id="risk-1">2.1%</span></td><td style="color:var(--success)">LOW</td></tr>
                                    <tr><td>BED 2</td><td>Risk: <span id="risk-2" class="risk-high">78.4%</span></td><td class="risk-high">HIGH</td></tr>
                                </table>
                            </div>

                            <div style="border-top:1px solid #333; padding-top:10px;">
                                <h4 style="margin:0 0 5px 0; color:gray; font-size:0.7rem;">GESTURES</h4>
                                <small style="font-size:0.6rem; opacity:0.7;">‚úä:Pain | ‚úåÔ∏è:Water | ‚úã:Light | üëå:Fan</small>
                            </div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div class="p-card" id="card-p1">
                            <div class="p-head">
                                <div><h4 style="margin:0">Alex Smith</h4><small style="color:gray;">Bed 1</small></div>
                                <span class="badge ok" id="bdg-p1">STABLE</span>
                            </div>
                            <div class="ecg-area"><canvas id="ecg-p1"></canvas></div>
                            <div class="saline-area">
                                <i class="fas fa-prescription-bottle text-accent"></i>
                                <div class="saline-track"><div class="saline-fill" id="sal-p1"></div></div>
                            </div>
                            <div id="req-p1" style="text-align:center; font-weight:bold;">--</div>
                        </div>

                        <div class="p-card" id="card-p2">
                            <div class="p-head">
                                <div><h4 style="margin:0">Sarah Doe</h4><small style="color:gray;">Bed 2</small></div>
                                <span class="badge ok" id="bdg-p2">STABLE</span>
                            </div>
                            <div class="ecg-area"><canvas id="ecg-p2"></canvas></div>
                            <div class="saline-area">
                                <i class="fas fa-prescription-bottle text-accent"></i>
                                <div class="saline-track"><div class="saline-fill" id="sal-p2"></div></div>
                            </div>
                            <div id="req-p2" style="text-align:center; font-weight:bold;">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-analytics" class="view-section">
                <h2>Live Analytics</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; height:60%;">
                    <div class="p-card"><canvas id="chart-requests"></canvas></div>
                    <div class="p-card"><canvas id="chart-urgency"></canvas></div>
                </div>
            </div>

            <div id="view-logs" class="view-section">
                <div class="p-card" style="height:100%;">
                    <h3>System Event Logs</h3>
                    <table style="width:100%; text-align:left;">
                        <tbody id="log-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="toast">Alert</div>

    <script>
        const VIDEO = document.getElementById('vid');
        const CANVAS = document.getElementById('can');
        const CTX = CANVAS.getContext('2d');
        let lastAction1 = "", lastAction2 = "";

        const System = {
            login: () => {
                const u = document.getElementById('u').value;
                const p = document.getElementById('p').value;
                if(u === 'admin' && p === 'admin123') {
                    document.getElementById('auth-layer').style.display = 'none';
                    document.getElementById('loader').style.display = 'flex';
                    document.getElementById('app-shell').style.display = 'flex';
                    Vision.start();
                    ECG.start(1); ECG.start(2);
                    Charts.init();
                    Saline.start();
                    CardiacAI.init();
                } else alert("Access Denied");
            },
            notify: (msg, crit) => {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.className = crit ? "toast show danger" : "toast show";
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(msg));
                setTimeout(() => t.classList.remove('show'), 3000);
                Logs.add(msg, crit ? 'CRIT' : 'INFO');
            },
            registerFace: () => {
                System.notify("Facial Scanning Active...", false);
                document.getElementById('ai-stat').innerText = "SCANNING";
                setTimeout(() => {
                    System.notify("Face Linked to Bed 1 Profile", false);
                    document.getElementById('ai-stat').innerText = "ACTIVE";
                }, 2000);
            }
        };

        const Router = {
            go: (id) => {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.getElementById(`view-${id}`).classList.add('active');
            }
        };

        const Vision = {
            start: async () => {
                const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
                holistic.setOptions({modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                holistic.onResults(Vision.process);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                    VIDEO.srcObject = stream;
                    VIDEO.onloadedmetadata = () => {
                        VIDEO.play();
                        document.getElementById('ai-stat').innerText = "ACTIVE";
                        const cam = new Camera(VIDEO, { onFrame: async () => { await holistic.send({image: VIDEO}); }, width: 1280, height: 720 });
                        cam.start();
                        document.getElementById('loader').style.display = 'none';
                    };
                } catch(e) { console.error(e); }
            },
            process: (results) => {
                CANVAS.width = VIDEO.videoWidth; CANVAS.height = VIDEO.videoHeight;
                CTX.save();
                CTX.clearRect(0, 0, CANVAS.width, CANVAS.height);
                CTX.drawImage(results.image, 0, 0, CANVAS.width, CANVAS.height);
                drawConnectors(CTX, results.leftHandLandmarks, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 2});
                drawConnectors(CTX, results.rightHandLandmarks, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 2});
                CTX.restore();

                if(results.rightHandLandmarks) {
                    Vision.analyzeHand(results.rightHandLandmarks, 1);
                    TwinDraw(results.rightHandLandmarks, 1);
                }
                if(results.leftHandLandmarks) {
                    Vision.analyzeHand(results.leftHandLandmarks, 2);
                    TwinDraw(results.leftHandLandmarks, 2);
                }
            },
            analyzeHand: (lm, bedId) => {
                let fingers = 0;
                if(lm[8].y < lm[6].y) fingers++;
                if(lm[12].y < lm[10].y) fingers++;
                const msg = fingers === 0 ? "PAIN" : fingers === 2 ? "WATER" : fingers === 5 ? "LIGHT" : "";
                if(msg && (bedId === 1 ? msg !== lastAction1 : msg !== lastAction2)) {
                    if(bedId === 1) lastAction1 = msg; else lastAction2 = msg;
                    System.notify(`Bed ${bedId}: ${msg}`, msg === "PAIN");
                    document.getElementById(`req-p${bedId}`).innerText = msg;
                    setTimeout(() => { if(bedId === 1) lastAction1 = ""; else lastAction2 = ""; }, 3000);
                }
            }
        };

        const TwinDraw = (lm, id) => {
            const c = document.getElementById(`twin-${id}`);
            const ctx = c.getContext('2d');
            c.width = c.offsetWidth; c.height = c.offsetHeight;
            ctx.clearRect(0,0,c.width,c.height);
            drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 1});
        };

        const ECG = {
            start: (id) => {
                const c = document.getElementById(`ecg-p${id}`);
                const ctx = c.getContext('2d');
                function resize() { c.width = c.offsetWidth; c.height = c.offsetHeight; }
                window.addEventListener('resize', resize); resize();
                let x = 0;
                function draw() {
                    x += 2;
                    if(x > c.width) { x = 0; ctx.clearRect(0,0,c.width,c.height); }
                    let y = c.height/2;
                    let p = x % 100;
                    if(p > 30 && p < 40) y -= 30; // R Wave
                    else if(p > 40 && p < 45) y += 10;
                    ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2;
                    ctx.lineTo(x, y); ctx.stroke();
                    requestAnimationFrame(draw);
                }
                draw();
            }
        };

        const CardiacAI = {
            init: () => {
                setInterval(() => {
                    const r2 = (70 + Math.random() * 20).toFixed(1);
                    document.getElementById('risk-2').innerText = r2 + "%";
                    if(r2 > 85) System.notify("CARDIAC ALERT BED 2", true);
                }, 10000);
            }
        };

        const Saline = {
            start: () => {
                let lvl = 100;
                setInterval(() => {
                    lvl -= 0.5; if(lvl < 0) lvl = 100;
                    document.getElementById('sal-p1').style.width = lvl + "%";
                    document.getElementById('sal-p2').style.width = (lvl*0.8) + "%";
                }, 2000);
            }
        };

        const Logs = { add: (m, t) => { document.getElementById('log-body').innerHTML = `<tr><td>${new Date().toLocaleTimeString()}</td><td>${m}</td><td>${t}</td></tr>` + document.getElementById('log-body').innerHTML; } };

        const Charts = {
            init: () => {
                new Chart(document.getElementById('chart-requests'), { type: 'doughnut', data: { labels: ['Pain', 'Water'], datasets: [{ data: [5, 12], backgroundColor: ['#ef4444', '#38bdf8'] }] } });
                new Chart(document.getElementById('chart-urgency'), { type: 'line', data: { labels: ['1pm', '2pm', '3pm'], datasets: [{ label: 'Risk', data: [10, 25, 15], borderColor: '#6366f1' }] } });
            }
        };
    </script>
</body>
</html>
