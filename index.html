<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VisionCare Enterprise | Central Command</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <style>
        /* ==========================================================================
           1. DESIGN SYSTEM (MediUI v6)
           ========================================================================== */
        :root {
            /* Palette */
            --bg-app: #0b1120;
            --bg-sidebar: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            
            /* Accents */
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            
            /* Text */
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            
            /* Dimensions */
            --sidebar-w: 280px;
            --header-h: 70px;
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-app); 
            color: var(--text-main); 
            height: 100vh; 
            width: 100vw; 
            overflow: hidden; 
            display: flex;
        }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 3px; }

        /* ANIMATIONS */
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ==========================================================================
           2. AUTHENTICATION
           ========================================================================== */
        #auth-layer {
            position: fixed; inset: 0; z-index: 9999;
            background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            display: flex; align-items: center; justify-content: center;
        }
        .auth-box {
            width: 420px; padding: 40px; background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .form-control {
            width: 100%; padding: 14px; margin: 10px 0; background: #020617; 
            border: 1px solid var(--bg-input); color: white; border-radius: var(--radius); 
            font-size: 1rem; text-align: center; transition: 0.3s;
        }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }
        .btn-primary {
            width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; border: none; border-radius: var(--radius); font-weight: 700; cursor: pointer;
            transition: 0.3s; margin-top: 10px; font-size: 1rem;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px var(--primary-glow); }

        /* ==========================================================================
           3. MAIN LAYOUT
           ========================================================================== */
        /* Sidebar */
        aside {
            width: var(--sidebar-w); background: var(--bg-sidebar); border-right: 1px solid var(--bg-input);
            display: flex; flex-direction: column; padding: 24px; z-index: 50;
        }
        .brand { 
            font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 40px; 
            display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px;
        }
        .brand i { color: var(--primary); font-size: 1.6rem; }
        
        .nav-item {
            padding: 14px 16px; margin-bottom: 5px; border-radius: var(--radius); color: var(--text-muted); 
            cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s;
        }
        .nav-item:hover, .nav-item.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .nav-item.active { border-left: 3px solid var(--primary); }

        /* Main Content */
        main { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; }
        
        /* Header */
        header {
            height: var(--header-h); border-bottom: 1px solid var(--bg-input);
            padding: 0 32px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(11, 17, 32, 0.95); backdrop-filter: blur(10px);
        }
        .header-left h2 { font-size: 1.25rem; font-weight: 700; margin: 0; }
        .header-left small { color: var(--text-muted); font-size: 0.85rem; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* Views */
        .view-container { flex: 1; overflow-y: auto; padding: 24px; position: relative; }
        .view-section { display: none; height: 100%; animation: fadeIn 0.4s ease; flex-direction: column; }
        .view-section.active { display: flex; }

        /* ==========================================================================
           4. DASHBOARD MODULES
           ========================================================================== */
        .dashboard-grid {
            display: grid; grid-template-columns: 2fr 1fr; grid-template-rows: 55% 45%; gap: 24px; height: 100%;
        }

        /* Camera Box */
        .cam-box {
            grid-column: 1 / 2; grid-row: 1 / 2;
            background: black; border-radius: var(--radius); border: 2px solid var(--bg-input);
            position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        video { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); }
        canvas { position: absolute; width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1); z-index: 10; }
        
        /* HUD Overlays */
        .hud-panel {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            background: rgba(0,0,0,0.8); border: 1px solid var(--bg-input);
            padding: 12px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
            color: var(--success); min-width: 200px; pointer-events: none;
        }
        .hud-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        
        .mic-badge {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            background: rgba(0,0,0,0.8); padding: 8px 16px; border-radius: 20px;
            display: flex; align-items: center; gap: 8px; border: 1px solid var(--bg-input);
            font-weight: 600; font-size: 0.85rem;
        }
        .mic-dot { width: 8px; height: 8px; border-radius: 50%; background: #64748b; }
        .mic-active .mic-dot { background: var(--danger); animation: pulse-red 1.5s infinite; }

        .cam-actions {
            position: absolute; bottom: 20px; z-index: 30; display: flex; gap: 12px;
            background: rgba(15, 23, 42, 0.9); padding: 8px; border-radius: 40px; border: 1px solid var(--bg-input);
        }
        .btn-action {
            background: transparent; border: 1px solid rgba(255,255,255,0.2); color: white;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
            transition: 0.2s;
        }
        .btn-action:hover { background: var(--primary); border-color: var(--primary); }

        /* Twin & Info */
        .side-stack {
            grid-column: 2 / 3; grid-row: 1 / 3;
            display: flex; flex-direction: column; gap: 20px;
        }
        
        .twin-box {
            flex: 1; background: #000; border-radius: var(--radius); border: 1px solid var(--accent);
            position: relative; overflow: hidden;
        }
        .legend-card {
            flex: 1; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--bg-input);
            display: flex; flex-direction: column; overflow: hidden;
        }
        
        .g-item {
            display: flex; align-items: center; gap: 16px; padding: 12px;
            background: rgba(255,255,255,0.03); border-radius: 12px; margin: 10px;
            border: 1px solid transparent; transition: 0.2s;
        }
        .g-item.active { border-color: var(--accent); background: rgba(6, 182, 212, 0.1); transform: scale(1.02); }
        .g-icon { font-size: 1.8rem; width: 40px; text-align: center; }

        /* Patient Grid */
        .patient-row {
            grid-column: 1 / 2; grid-row: 2 / 3;
            display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
        }
        .p-card {
            background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--bg-input);
            padding: 20px; display: flex; flex-direction: column; position: relative; transition: 0.3s;
        }
        .p-card.alert { border-color: var(--danger); box-shadow: 0 0 30px rgba(239, 68, 68, 0.2); }
        
        .p-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .p-avatar { width: 60px; height: 60px; border-radius: 16px; background: #334155; object-fit: cover; border: 2px solid var(--bg-input); }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; }
        .badge-ok { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .badge-crit { background: rgba(239, 68, 68, 0.15); color: var(--danger); animation: pulse-red 1s infinite; }

        .ecg-display { flex: 1; background: #000; border-radius: 8px; position: relative; overflow: hidden; border: 1px solid var(--bg-input); margin-bottom: 10px; }
        .ecg-canvas { width: 100%; height: 100%; }
        
        .controls-row { display: flex; gap: 15px; align-items: center; }
        .saline-box { flex: 1; display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; }
        .saline-bar { flex: 1; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .saline-fill { height: 100%; width: 80%; background: var(--accent); transition: 1s; }
        
        .room-btn { 
            width: 40px; height: 40px; border-radius: 10px; background: var(--bg-sidebar); color: var(--text-muted); 
            border: 1px solid var(--bg-input); display: flex; align-items: center; justify-content: center; transition: 0.3s;
        }
        .room-btn.on { background: var(--warning); color: black; border-color: var(--warning); box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }
        .room-btn.fan-spin i { animation: spin 1s linear infinite; }

        /* ==========================================================================
           5. ANALYTICS & CHAT VIEWS
           ========================================================================== */
        .analytics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .chart-card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; border: 1px solid var(--bg-input); height: 350px; }

        .chat-layout { display: flex; height: 100%; gap: 20px; }
        .chat-list { width: 250px; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--bg-input); padding: 10px; }
        .chat-main { flex: 1; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--bg-input); display: flex; flex-direction: column; }
        
        /* ==========================================================================
           6. NOTIFICATIONS
           ========================================================================== */
        .toast-container {
            position: fixed; top: 24px; right: 24px; z-index: 10000;
            display: flex; flex-direction: column; gap: 12px; pointer-events: none;
        }
        .toast {
            width: 350px; padding: 16px; background: white; color: var(--bg-app);
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; align-items: flex-start; gap: 16px;
            border-left: 5px solid var(--primary); animation: fadeIn 0.4s ease; pointer-events: auto;
        }
        .toast.danger { border-left-color: var(--danger); background: #fef2f2; color: #991b1b; }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="auth-box">
            <i class="fas fa-heart-pulse" style="font-size: 3.5rem; color: var(--primary); margin-bottom: 20px;"></i>
            <h2 style="margin-bottom: 10px;">VisionCare Enterprise</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Secure ICU Login</p>
            <input type="text" id="auth-user" class="form-control" placeholder="ID (admin)" value="admin">
            <input type="password" id="auth-pass" class="form-control" placeholder="PIN (admin123)" value="admin123">
            <button class="btn-primary" onclick="System.login()">INITIALIZE SYSTEM</button>
        </div>
    </div>

    <aside>
        <div class="brand"><i class="fas fa-eye"></i> VisionCare</div>
        <div class="nav-item active" onclick="Router.go('dashboard')"><i class="fas fa-desktop"></i> Monitor</div>
        <div class="nav-item" onclick="Router.go('analytics')"><i class="fas fa-chart-bar"></i> Analytics</div>
        <div class="nav-item" onclick="Router.go('chat')"><i class="fas fa-comments"></i> Staff Chat</div>
        <div class="nav-item" onclick="Router.go('logs')"><i class="fas fa-list-alt"></i> Patient Logs</div>
        <div class="nav-item" onclick="Router.go('settings')"><i class="fas fa-cog"></i> Settings</div>
        <div style="margin-top:auto">
            <div class="nav-item" style="color:var(--danger)" onclick="location.reload()"><i class="fas fa-power-off"></i> Logout</div>
        </div>
    </aside>

    <main>
        <header>
            <div class="header-left">
                <h2>ICU Ward 104</h2>
                <small>Central Command Station</small>
            </div>
            <div class="header-right">
                <div style="text-align:right">
                    <div style="font-weight:700">Dr. Admin</div>
                    <div style="font-size:0.8rem; color:var(--text-muted)">Chief Medical Officer</div>
                </div>
                <div class="status-dot"></div>
            </div>
        </header>

        <div class="view-container">
            
            <div id="view-dashboard" class="view-section active">
                <div class="dashboard-grid">
                    
                    <div class="cam-box">
                        <video id="vid" playsinline muted></video>
                        <canvas id="can"></canvas>
                        
                        <div class="hud-panel">
                            <div class="hud-row"><span style="color:var(--text-muted)">AI Status:</span> <span id="ai-stat">IDLE</span></div>
                            <div class="hud-row"><span style="color:var(--text-muted)">Bed 1 Fingers:</span> <span id="debug-b1">0</span></div>
                            <div class="hud-row"><span style="color:var(--text-muted)">Bed 2 Fingers:</span> <span id="debug-b2">0</span></div>
                            <div class="hud-row" style="margin-top:5px; border-top:1px solid #333; padding-top:5px;">
                                <span>CMD:</span> <span id="debug-cmd" style="color:var(--warning)">--</span>
                            </div>
                        </div>

                        <div class="mic-badge" id="mic-ui">
                            <div class="mic-dot"></div> <span id="mic-text">VOICE OFF</span>
                        </div>

                        <div class="cam-actions">
                            <button class="btn-action" onclick="PatientMgr.snap(1)">üì∏ Bed 1</button>
                            <button class="btn-action" style="background:var(--primary); border-color:var(--primary)" onclick="VisionKernel.start()">‚ñ∂ START AI</button>
                            <button class="btn-action" onclick="VoiceKernel.toggle()">üéôÔ∏è Voice</button>
                            <button class="btn-action" onclick="PatientMgr.snap(2)">üì∏ Bed 2</button>
                        </div>
                    </div>

                    <div class="side-stack">
                        <div class="twin-box">
                            <canvas id="twin_can" style="width:100%; height:100%;"></canvas>
                            <div style="position:absolute; top:10px; left:10px; color:var(--accent); font-weight:bold; font-size:0.8rem; background:rgba(0,0,0,0.7); padding:4px;">DIGITAL TWIN</div>
                        </div>
                        <div class="legend-card">
                            <div class="g-item" id="g-pain"><span class="g-icon">‚úä</span><div><strong>Fist</strong><br><small class="text-muted">Emergency</small></div></div>
                            <div class="g-item" id="g-water"><span class="g-icon">‚úåÔ∏è</span><div><strong>V-Sign</strong><br><small class="text-muted">Water</small></div></div>
                            <div class="g-item" id="g-light"><span class="g-icon">‚úã</span><div><strong>Palm</strong><br><small class="text-muted">Lights</small></div></div>
                            <div class="g-item" id="g-fan"><span class="g-icon">üëå</span><div><strong>Pinch</strong><br><small class="text-muted">Fan</small></div></div>
                        </div>
                    </div>

                    <div class="patient-row">
                        <div class="p-card" id="card-p1">
                            <div class="p-header">
                                <div style="display:flex; gap:15px; align-items:center;">
                                    <img id="img-p1" src="https://via.placeholder.com/80/1e293b/475569?text=Bed1" class="p-avatar">
                                    <div><h3>Bed 1</h3><small class="text-muted">Cardiac Unit</small></div>
                                </div>
                                <span class="badge badge-ok" id="bdg-p1">STABLE</span>
                            </div>
                            <div class="ecg-display"><canvas id="ecg-p1"></canvas></div>
                            <div style="font-weight:700; font-size:1.2rem; text-align:center; margin-bottom:10px;" id="req-p1">--</div>
                            <div class="controls-row">
                                <div class="saline-box"><div class="saline-bar"><div class="saline-fill" id="sal-p1"></div></div><small>80%</small></div>
                                <div class="room-btn" id="btn-light-p1"><i class="fas fa-lightbulb"></i></div>
                                <div class="room-btn" id="btn-fan-p1"><i class="fas fa-fan"></i></div>
                            </div>
                        </div>

                        <div class="p-card" id="card-p2">
                            <div class="p-header">
                                <div style="display:flex; gap:15px; align-items:center;">
                                    <img id="img-p2" src="https://via.placeholder.com/80/1e293b/475569?text=Bed2" class="p-avatar">
                                    <div><h3>Bed 2</h3><small class="text-muted">Ortho Unit</small></div>
                                </div>
                                <span class="badge badge-ok" id="bdg-p2">STABLE</span>
                            </div>
                            <div class="ecg-display"><canvas id="ecg-p2"></canvas></div>
                            <div style="font-weight:700; font-size:1.2rem; text-align:center; margin-bottom:10px;" id="req-p2">--</div>
                            <div class="controls-row">
                                <div class="saline-box"><div class="saline-bar"><div class="saline-fill" id="sal-p2" style="width:40%; background:var(--warning)"></div></div><small>40%</small></div>
                                <div class="room-btn" id="btn-light-p2"><i class="fas fa-lightbulb"></i></div>
                                <div class="room-btn" id="btn-fan-p2"><i class="fas fa-fan"></i></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="view-analytics" class="view-section">
                <h2 style="margin-bottom:20px;">Performance Analytics</h2>
                <div class="analytics-grid">
                    <div class="chart-card">
                        <canvas id="chart-requests"></canvas>
                    </div>
                    <div class="chart-card">
                        <canvas id="chart-urgency"></canvas>
                    </div>
                </div>
            </div>

            <div id="view-chat" class="view-section">
                <div class="chat-layout">
                    <div class="chat-list">
                        <div style="padding:10px; border-bottom:1px solid var(--bg-input); font-weight:bold;">Active Staff</div>
                        <div style="padding:15px; cursor:pointer; background:rgba(255,255,255,0.05); margin-top:5px;">Nurse Station A</div>
                        <div style="padding:15px; cursor:pointer;">Lab Technician</div>
                    </div>
                    <div class="chat-main">
                        <div style="flex:1; padding:20px;">
                            <div style="background:var(--bg-input); padding:10px; border-radius:10px; margin-bottom:10px; max-width:70%;">Dr. Admin, Bed 1 saline is low.</div>
                            <div style="background:var(--primary); color:white; padding:10px; border-radius:10px; margin-bottom:10px; max-width:70%; margin-left:auto;">Copy. AI monitoring is active.</div>
                        </div>
                        <div style="padding:15px; border-top:1px solid var(--bg-input); display:flex; gap:10px;">
                            <input type="text" class="form-control" placeholder="Type message..." style="margin:0;">
                            <button class="btn-primary" style="margin:0;"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-logs" class="view-section">
                <div class="p-card">
                    <h3>System Event Logs</h3>
                    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
                        <thead style="border-bottom:1px solid var(--bg-input); text-align:left;">
                            <tr><th style="padding:10px;">Time</th><th>Source</th><th>Event</th><th>Type</th></tr>
                        </thead>
                        <tbody id="log-body">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <div id="toast-area" class="toast-container"></div>

    <script>
        /**
         * =========================================
         * 1. CORE SYSTEM
         * =========================================
         */
        const System = {
            init: () => {
                if(!localStorage.getItem('vc_logs')) localStorage.setItem('vc_logs', JSON.stringify([]));
                ECG.start(1); ECG.start(2);
            },
            login: () => {
                const u = document.getElementById('auth-user').value;
                const p = document.getElementById('auth-pass').value;
                if(u === 'admin' && p === 'admin123') {
                    document.getElementById('auth-layer').style.display = 'none';
                    VoiceKernel.speak("System Online. Welcome Doctor.");
                    Charts.init();
                    System.loadLogs();
                } else alert("Invalid Credentials");
            },
            notify: (title, msg, isCrit) => {
                const area = document.getElementById('toast-area');
                const t = document.createElement('div');
                t.className = `toast ${isCrit ? 'danger' : ''}`;
                t.innerHTML = `
                    <div style="font-size:1.5rem">${isCrit ? 'üö®' : 'üîî'}</div>
                    <div><div style="font-weight:700">${title}</div><small>${msg}</small></div>
                `;
                area.appendChild(t);
                VoiceKernel.speak(msg);
                setTimeout(() => t.remove(), 4000);
            },
            log: (src, evt, type) => {
                const logs = JSON.parse(localStorage.getItem('vc_logs'));
                logs.unshift({ time: new Date().toLocaleTimeString(), src, evt, type });
                if(logs.length > 50) logs.pop();
                localStorage.setItem('vc_logs', JSON.stringify(logs));
                System.loadLogs();
            },
            loadLogs: () => {
                const logs = JSON.parse(localStorage.getItem('vc_logs'));
                document.getElementById('log-body').innerHTML = logs.map(l => `
                    <tr style="border-bottom:1px solid rgba(255,255,255,0.05)">
                        <td style="padding:10px; color:var(--accent)">${l.time}</td>
                        <td>${l.src}</td><td>${l.evt}</td>
                        <td><span class="badge ${l.type==='CRIT'?'badge-crit':'badge-ok'}">${l.type}</span></td>
                    </tr>
                `).join('');
            }
        };

        const Router = {
            go: (id) => {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.getElementById(`view-${id}`).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                event.currentTarget.classList.add('active');
                VoiceKernel.speak(`Opening ${id}`);
            }
        };

        /**
         * =========================================
         * 2. VISION KERNEL (MULTI-HAND + TWIN)
         * =========================================
         */
        const VisionKernel = {
            video: document.getElementById('vid'),
            canvas: document.getElementById('can'),
            ctx: document.getElementById('can').getContext('2d'),
            twinCanvas: document.getElementById('twin_can'),
            twinCtx: document.getElementById('twin_can').getContext('2d'),
            lastAction: "",

            start: async () => {
                document.getElementById('ai-stat').innerText = "LOADING...";
                const holistic = new Holistic({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`});
                holistic.setOptions({maxNumHands: 2, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
                holistic.onResults(VisionKernel.process);

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                    VisionKernel.video.srcObject = stream;
                    VisionKernel.video.onloadedmetadata = () => {
                        VisionKernel.video.play();
                        document.getElementById('ai-stat').innerText = "ACTIVE";
                        document.getElementById('ai-stat').style.color = "var(--success)";
                        const cam = new Camera(VisionKernel.video, {
                            onFrame: async () => { await holistic.send({image: VisionKernel.video}); },
                            width: 1280, height: 720
                        });
                        cam.start();
                    };
                } catch(e) { alert("Camera Access Denied"); }
            },

            process: (results) => {
                // A. Main Overlay
                const ctx = VisionKernel.ctx;
                const w = VisionKernel.canvas.width = VisionKernel.video.videoWidth;
                const h = VisionKernel.canvas.height = VisionKernel.video.videoHeight;
                ctx.clearRect(0, 0, w, h);
                ctx.drawImage(results.image, 0, 0, w, h);
                // Splitter
                ctx.beginPath(); ctx.moveTo(w/2, 0); ctx.lineTo(w/2, h); ctx.strokeStyle="rgba(255,255,255,0.3)"; ctx.lineWidth=2; ctx.stroke();
                
                // Draw Hands
                if(results.leftHandLandmarks) drawConnectors(ctx, results.leftHandLandmarks, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 3});
                if(results.rightHandLandmarks) drawConnectors(ctx, results.rightHandLandmarks, HAND_CONNECTIONS, {color: '#6366f1', lineWidth: 3});

                // B. Digital Twin
                const tCtx = VisionKernel.twinCtx;
                VisionKernel.twinCanvas.width = w; VisionKernel.twinCanvas.height = h;
                tCtx.save(); tCtx.clearRect(0, 0, w, h);
                drawConnectors(tCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#06b6d4', lineWidth: 3});
                drawLandmarks(tCtx, results.poseLandmarks, {color: '#fff', lineWidth: 1});
                tCtx.restore();

                // C. Logic (Split Screen)
                if (results.leftHandLandmarks) VisionKernel.logic(results.leftHandLandmarks);
                if (results.rightHandLandmarks) VisionKernel.logic(results.rightHandLandmarks);
            },

            logic: (lm) => {
                // Bed ID based on X pos
                const bedId = lm[0].x < 0.5 ? 1 : 2;
                
                // Count Fingers
                let fingers = 0;
                if (lm[8].y < lm[6].y) fingers++;
                if (lm[12].y < lm[10].y) fingers++;
                if (lm[16].y < lm[14].y) fingers++;
                if (lm[20].y < lm[18].y) fingers++;
                if (Math.abs(lm[4].x - lm[5].x) > 0.05) fingers++;

                const isPinch = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y) < 0.05;

                // Update HUD
                document.getElementById(`debug-b${bedId}`).innerText = fingers;

                let msg = "";
                if (isPinch) msg = "FAN ON";
                else if (fingers === 0) msg = "PAIN";
                else if (fingers === 5) msg = "LIGHT ON";
                else if (fingers === 2) msg = "WATER";

                document.getElementById('debug-cmd').innerText = msg || "--";

                if (msg && msg !== VisionKernel.lastAction) {
                    VisionKernel.lastAction = msg;
                    RoomMgr.handle(bedId, msg);
                    setTimeout(() => VisionKernel.lastAction = "", 2000);
                }
            }
        };

        // --- ROOM MANAGER ---
        const RoomMgr = {
            handle: (id, msg) => {
                document.getElementById(`req-p${id}`).innerText = msg;
                document.querySelectorAll('.g-item').forEach(e => e.classList.remove('active'));

                if (msg === "PAIN") {
                    document.getElementById('g-pain').classList.add('active');
                    document.getElementById(`card-p${id}`).classList.add('alert');
                    document.getElementById(`bdg-p${id}`).className = "badge badge-crit";
                    document.getElementById(`bdg-p${id}`).innerText = "CRITICAL";
                    System.notify(`EMERGENCY`, `Bed ${id} Pain Alert`, true);
                    System.log(`Bed ${id}`, `PAIN ALERT`, 'CRIT');
                } else if (msg) {
                    const map = { "FAN ON": "g-fan", "LIGHT ON": "g-light", "WATER": "g-water" };
                    if(map[msg]) document.getElementById(map[msg]).classList.add('active');
                    System.notify(`Bed ${id}`, `Request: ${msg}`, false);
                    System.log(`Bed ${id}`, `Req: ${msg}`, 'OK');
                }
            }
        };

        const PatientMgr = {
            snap: (id) => {
                const c = document.createElement('canvas');
                c.width = 1280; c.height = 720;
                c.getContext('2d').drawImage(VisionKernel.video, 0, 0);
                document.getElementById(`img-p${id}`).src = c.toDataURL('image/png');
                VoiceKernel.speak(`Bed ${id} Registered`);
            }
        };

        /**
         * =========================================
         * 3. VOICE KERNEL (DOCTOR)
         * =========================================
         */
        const VoiceKernel = {
            rec: null,
            isActive: false,

            init: () => {
                const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!Recognition) return alert("Browser does not support Voice");
                
                VoiceKernel.rec = new Recognition();
                VoiceKernel.rec.lang = 'en-US';
                VoiceKernel.rec.continuous = false; 
                
                VoiceKernel.rec.onresult = (e) => {
                    const cmd = e.results[0][0].transcript.toLowerCase();
                    System.notify("Voice Heard", cmd, false);
                    VoiceKernel.process(cmd);
                };
                
                VoiceKernel.rec.onend = () => {
                    if (VoiceKernel.isActive) VoiceKernel.rec.start();
                };
            },

            toggle: () => {
                if(!VoiceKernel.rec) VoiceKernel.init();
                const ui = document.getElementById('mic-ui');
                const txt = document.getElementById('mic-text');

                if(!VoiceKernel.isActive) {
                    VoiceKernel.isActive = true;
                    VoiceKernel.rec.start();
                    ui.classList.add('mic-active');
                    txt.innerText = "LISTENING...";
                } else {
                    VoiceKernel.isActive = false;
                    VoiceKernel.rec.stop();
                    ui.classList.remove('mic-active');
                    txt.innerText = "VOICE OFF";
                }
            },

            process: (cmd) => {
                if (cmd.includes("analytics")) Router.go('analytics');
                else if (cmd.includes("monitor")) Router.go('dashboard');
                else if (cmd.includes("log")) Router.go('logs');
                else if (cmd.includes("chat")) Router.go('chat');
                else if (cmd.includes("fan")) RoomMgr.handle(1, "FAN ON");
                else if (cmd.includes("light")) RoomMgr.handle(1, "LIGHT ON");
                else if (cmd.includes("emergency")) RoomMgr.handle(1, "PAIN");
            },

            speak: (txt) => {
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
            }
        };

        /**
         * =========================================
         * 4. ANALYTICS & ECG
         * =========================================
         */
        const ECG = {
            start: (id) => {
                const c = document.getElementById(`ecg-p${id}`);
                const cx = c.getContext('2d');
                c.width = c.offsetWidth; c.height = c.offsetHeight;
                let x = 0; cx.strokeStyle = '#10b981'; cx.lineWidth = 2; cx.beginPath(); cx.moveTo(0, c.height/2);
                function loop() {
                    x += 2;
                    if(x > c.width) { x = 0; cx.clearRect(0,0,c.width,c.height); cx.beginPath(); cx.moveTo(0, c.height/2); }
                    let y = c.height/2; if(Math.random() < 0.05) y -= 30;
                    cx.lineTo(x, y); cx.stroke(); requestAnimationFrame(loop);
                }
                loop();
            }
        };

        const Charts = {
            init: () => {
                new Chart(document.getElementById('chart-requests'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Water', 'Meds', 'Pain', 'Fan', 'Light'],
                        datasets: [{ data: [12, 8, 3, 15, 7], backgroundColor: ['#06b6d4', '#6366f1', '#ef4444', '#f59e0b', '#10b981'] }]
                    },
                    options: { maintainAspectRatio: false }
                });
                new Chart(document.getElementById('chart-urgency'), {
                    type: 'line',
                    data: {
                        labels: ['10AM', '11AM', '12PM', '1PM', '2PM'],
                        datasets: [{ label: 'Response Time (s)', data: [45, 30, 25, 40, 20], borderColor: '#6366f1', tension: 0.4 }]
                    },
                    options: { maintainAspectRatio: false }
                });
            }
        };

        // STARTUP
        System.init();
    </script>
</body>
</html>
